<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POSPal Demo Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen font-sans">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-lg">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">POSPal Demo Generator</h1>
        <p class="text-gray-600 mb-6">Upload your main `POSPal.html` file to generate a demo version with offline capabilities and mock data.</p>
        
        <div class="mb-4">
            <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-2">1. Upload your live POSPal.html file:</label>
            <input type="file" id="fileInput" accept=".html" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
        </div>

        <button id="generateBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-md hover:bg-blue-700 transition disabled:bg-gray-400">
            2. Generate Demo Version
        </button>

        <div id="status" class="mt-4 text-center text-sm text-green-700 font-medium"></div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const generateBtn = document.getElementById('generateBtn');
        const statusDiv = document.getElementById('status');
        let liveHtmlContent = '';

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type === 'text/html') {
                const reader = new FileReader();
                reader.onload = (e) => {
                    liveHtmlContent = e.target.result;
                    statusDiv.textContent = `✅ File "${file.name}" loaded successfully.`;
                };
                reader.onerror = () => {
                    statusDiv.textContent = `❌ Error reading file.`;
                    liveHtmlContent = '';
                };
                reader.readAsText(file);
            } else {
                statusDiv.textContent = 'Please upload a valid .html file.';
                liveHtmlContent = '';
            }
        });

        generateBtn.addEventListener('click', () => {
            if (!liveHtmlContent) {
                statusDiv.textContent = '❌ Please upload a file first.';
                return;
            }
            try {
                // --- Transformation Logic ---
                let demoHtml = liveHtmlContent;

                // 1. Add the demo banner
                const banner = `
    <div id="demo-mode-banner" class="hidden bg-yellow-400 text-yellow-900 text-center text-sm font-semibold p-2 sticky top-0 z-[100]">
        DEMO MODE: Saving and printing are disabled.
    </div>`;
                demoHtml = demoHtml.replace(/<body(.*?)>/, `<body$1>${banner}`);

                // 2. Replace the entire script block with the demo-aware version
                const newScript = getDemoScript();
                demoHtml = demoHtml.replace(/<script>([\s\S]*?)<\/script>/, `<script>${newScript}<\/script>`);

                // --- Download Logic ---
                const blob = new Blob([demoHtml], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'POSPal_Demo.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                statusDiv.textContent = '✅ Demo version generated and download started!';

            } catch (error) {
                statusDiv.textContent = `❌ An error occurred: ${error.message}`;
                console.error(error);
            }
        });

        // This function contains the entire JavaScript block for the demo version.
        function getDemoScript() {
            return `
        // --- Global State & Configuration ---
        let demoMode = false;
        let menu = {}; 
        let selectedCategory = null; 
        let editingItem = null; 
        let currentOrder = JSON.parse(localStorage.getItem('pospalCurrentOrder')) || [];
        let currentOrderLineItemCounter = parseInt(localStorage.getItem('pospalOrderLineItemCounter')) || 0; 
        let orderNumber = 1; 
        let universalOrderComment = localStorage.getItem('pospalUniversalOrderComment') || "";
        let selectedTableNumber = localStorage.getItem('pospalSelectedTable') || "";
        let isPaidByCard = false;

        let isMobileOrderPanelOpen = false;
        let itemForNumpad = null; 
        let numpadCurrentInput = "";

        let itemBeingConfigured = null; 
        let currentOptionSelectionStep = null; 

        const SELECTED_TABLE_KEY = 'pospalSelectedTable';

        const elements = {}; 

        function cacheDOMElements() {
            elements.headerOrderNumber = document.getElementById('header-order-number');
            elements.headerTableNumberInput = document.getElementById('header-table-number-input');
            elements.categoriesContainer = document.getElementById('categories');
            elements.productsContainer = document.getElementById('products');
            elements.orderItemsContainer = document.getElementById('order-items-container');
            elements.emptyOrderMessage = document.getElementById('empty-order-message');
            elements.orderTotalDisplay = document.getElementById('order-total');
            elements.universalOrderCommentInput = document.getElementById('universalOrderCommentInput');
            elements.paidByCardCheckbox = document.getElementById('paidByCardCheckbox');
            elements.mobileOrderToggle = document.getElementById('mobile-order-toggle');
            elements.mobileOrderCountBadge = document.getElementById('mobile-order-count-badge');
            elements.orderPanel = document.getElementById('order-panel');
            elements.orderPanelBackdrop = document.getElementById('order-panel-backdrop');
            elements.sendOrderBtn = document.getElementById('sendOrderBtn');
            elements.settingsGearContainer = document.getElementById('settings-gear-container');
            elements.managementModal = document.getElementById('managementModal');
            elements.daySummaryModal = document.getElementById('daySummaryModal');
            elements.daySummaryContent = document.getElementById('daySummaryContent');
            elements.itemOptionSelectModal = document.getElementById('itemOptionSelectModal');
            elements.optionModalItemName = document.getElementById('optionModalItemName');
            elements.optionModalItemDescription = document.getElementById('optionModalItemDescription');
            elements.optionModalOptionsContainer = document.getElementById('optionModalOptionsContainer');
            elements.confirmOptionBtn = document.getElementById('confirmOptionBtn');
            elements.itemNameInput = document.getElementById('itemName');
            elements.itemPriceInput = document.getElementById('itemPrice');
            elements.itemCategorySelect = document.getElementById('itemCategory');
            elements.itemIdInput = document.getElementById('itemId'); 
            elements.saveItemBtn = document.getElementById('saveItemBtn');
            elements.cancelEditBtn = document.getElementById('cancelEditBtn');
            elements.existingItemsListModal = document.getElementById('existingItemsListModal');
            elements.itemHasOptionsCheckboxModal = document.getElementById('itemHasOptionsModal'); 
            elements.itemOptionsModalContainer = document.getElementById('itemOptionsModalContainer');
            elements.itemOptionsListDisplayModal = document.getElementById('itemOptionsListDisplayModal');
            elements.newOptionNameInputModal = document.getElementById('newOptionNameInputModal');
            elements.newOptionPriceInputModal = document.getElementById('newOptionPriceInputModal'); 
            elements.categoryNameInput = document.getElementById('categoryName');
            elements.existingCategoriesListModal = document.getElementById('existingCategoriesListModal');
            elements.toast = document.getElementById('toast');
            elements.toastMessage = document.getElementById('toast-message');
            elements.numpadContainer = document.getElementById('numpad-container');
            elements.numpadItemNameDisplay = document.getElementById('numpad-item-name');
            elements.todaysOrdersList = document.getElementById('todaysOrdersList');
            elements.appVersionContainer = document.getElementById('appVersionContainer');
            elements.appVersion = document.getElementById('appVersion');
            elements.demoModeBanner = document.getElementById('demo-mode-banner');
            elements.mainHeader = document.getElementById('main-header');
            elements.categorySection = document.getElementById('category-section');
        }
        
        const mockMenu = {
            "Starters": [
                {"id": 1, "name": "Garlic Bread", "price": 4.50, "hasGeneralOptions": true, "generalOptions": [{"name": "Add Cheese", "priceChange": 1.00}]},
                {"id": 2, "name": "Bruschetta", "price": 6.50, "hasGeneralOptions": false, "generalOptions": []},
                {"id": 3, "name": "Soup of the Day", "price": 5.00, "hasGeneralOptions": false, "generalOptions": []},
                {"id": 4, "name": "Spring Rolls", "price": 5.50, "hasGeneralOptions": false, "generalOptions": []}
            ],
            "Salads": [
                {"id": 10, "name": "Caesar Salad", "price": 9.00, "hasGeneralOptions": true, "generalOptions": [{"name": "Add Chicken", "priceChange": 3.00}, {"name": "Add Bacon", "priceChange": 2.00}]},
                {"id": 11, "name": "Greek Salad", "price": 8.50, "hasGeneralOptions": false, "generalOptions": []},
                {"id": 12, "name": "Garden Salad", "price": 7.00, "hasGeneralOptions": false, "generalOptions": []}
            ],
            "Main Courses": [
                {"id": 20, "name": "Spaghetti Carbonara", "price": 12.50, "hasGeneralOptions": true, "generalOptions": [{"name": "Extra Bacon", "priceChange": 2.00}, {"name": "Gluten-Free Pasta", "priceChange": 1.50}]},
                {"id": 21, "name": "Margherita Pizza", "price": 10.00, "hasGeneralOptions": true, "generalOptions": [{"name": "Extra Topping", "priceChange": 1.50}, {"name": "Stuffed Crust", "priceChange": 2.50}]},
                {"id": 22, "name": "Grilled Salmon", "price": 16.00, "hasGeneralOptions": false, "generalOptions": []},
                {"id": 23, "name": "Classic Burger", "price": 11.50, "hasGeneralOptions": true, "generalOptions": [{"name": "Add Cheese", "priceChange": 1.00}, {"name": "Add Bacon", "priceChange": 1.50}]},
                {"id": 24, "name": "Chicken Curry", "price": 13.00, "hasGeneralOptions": false, "generalOptions": []}
            ],
            "Sandwiches": [
                {"id": 30, "name": "Club Sandwich", "price": 8.50, "hasGeneralOptions": false, "generalOptions": []},
                {"id": 31, "name": "BLT", "price": 7.00, "hasGeneralOptions": false, "generalOptions": []},
                {"id": 32, "name": "Tuna Melt", "price": 7.50, "hasGeneralOptions": false, "generalOptions": []}
            ],
            "Desserts": [
                {"id": 40, "name": "Chocolate Cake", "price": 5.50, "hasGeneralOptions": true, "generalOptions": [{"name": "Add Ice Cream", "priceChange": 1.50}]},
                {"id": 41, "name": "Apple Pie", "price": 5.00, "hasGeneralOptions": true, "generalOptions": [{"name": "Add Cream", "priceChange": 1.00}]},
                {"id": 42, "name": "Cheesecake", "price": 6.00, "hasGeneralOptions": false, "generalOptions": []},
                {"id": 43, "name": "Ice Cream Scoop", "price": 2.50, "hasGeneralOptions": false, "generalOptions": []}
            ],
            "Soft Drinks": [
                {"id": 50, "name": "Coca-Cola", "price": 2.50, "hasGeneralOptions": false, "generalOptions": []},
                {"id": 51, "name": "Sprite", "price": 2.50, "hasGeneralOptions": false, "generalOptions": []},
                {"id": 52, "name": "Fanta", "price": 2.50, "hasGeneralOptions": false, "generalOptions": []},
                {"id": 53, "name": "Still Water", "price": 1.50, "hasGeneralOptions": false, "generalOptions": []},
                {"id": 54, "name": "Sparkling Water", "price": 2.00, "hasGeneralOptions": false, "generalOptions": []},
                {"id": 55, "name": "Orange Juice", "price": 3.00, "hasGeneralOptions": false, "generalOptions": []}
            ],
            "Coffee & Tea": [
                {"id": 60, "name": "Espresso", "price": 2.00, "hasGeneralOptions": false, "generalOptions": []},
                {"id": 61, "name": "Cappuccino", "price": 3.00, "hasGeneralOptions": true, "generalOptions": [{"name": "Oat Milk", "priceChange": 0.50}, {"name": "Extra Shot", "priceChange": 0.75}]},
                {"id": 62, "name": "Latte", "price": 3.50, "hasGeneralOptions": true, "generalOptions": [{"name": "Soy Milk", "priceChange": 0.50}, {"name": "Caramel Syrup", "priceChange": 0.50}]},
                {"id": 63, "name": "Black Tea", "price": 2.50, "hasGeneralOptions": false, "generalOptions": []},
                {"id": 64, "name": "Green Tea", "price": 2.50, "hasGeneralOptions": false, "generalOptions": []}
            ]
        };

        function showDemoModeBanner() {
            if(elements.demoModeBanner) {
                elements.demoModeBanner.classList.remove('hidden');
                elements.mainHeader.style.top = elements.demoModeBanner.offsetHeight + 'px';
                elements.categorySection.style.top = (elements.demoModeBanner.offsetHeight + 61) + 'px';
            }
        }

        async function initializeAppState() {
            try {
                const response = await fetch('/api/order_status', { method: 'GET', signal: AbortSignal.timeout(2000) });
                if (!response.ok) throw new Error('Server not found');
                const data = await response.json();
                orderNumber = data.next_order_number;
                if(elements.headerOrderNumber) elements.headerOrderNumber.textContent = orderNumber;
                loadMenu(); // Load from server
            } catch (error) {
                console.warn("Could not connect to server, entering DEMO MODE.");
                demoMode = true;
                showDemoModeBanner();
                menu = mockMenu; // Load mock menu
                if(elements.headerOrderNumber) elements.headerOrderNumber.textContent = "1";
                // Manually set selectedCategory and render
                if (Object.keys(menu).length > 0) {
                    selectedCategory = Object.keys(menu)[0];
                }
                renderCategories();
                populateManagementCategorySelect();
            }
            selectedTableNumber = localStorage.getItem(SELECTED_TABLE_KEY) || "";
            if(elements.headerTableNumberInput) elements.headerTableNumberInput.value = selectedTableNumber;
        }

        document.addEventListener('DOMContentLoaded', () => {
            cacheDOMElements();
            initializeAppState();
            
            if(elements.universalOrderCommentInput) {
                elements.universalOrderCommentInput.value = universalOrderComment;
                elements.universalOrderCommentInput.addEventListener('input', (e) => {
                    universalOrderComment = e.target.value;
                    localStorage.setItem('pospalUniversalOrderComment', universalOrderComment);
                });
            }
            
            if(elements.paidByCardCheckbox) {
                elements.paidByCardCheckbox.addEventListener('change', (e) => {
                    isPaidByCard = e.target.checked;
                });
            }

            if(elements.headerTableNumberInput) {
                elements.headerTableNumberInput.value = selectedTableNumber;
                elements.headerTableNumberInput.addEventListener('input', (e) => {
                    selectedTableNumber = e.target.value.trim();
                    localStorage.setItem(SELECTED_TABLE_KEY, selectedTableNumber);
                });
            }
            updateOrderDisplay();
        });

        async function fetchAndUpdateOrderNumber() {
            if (demoMode) {
                orderNumber++;
                if(elements.headerOrderNumber) elements.headerOrderNumber.textContent = orderNumber;
                return;
            }
            try {
                const response = await fetch('/api/order_status');
                if (!response.ok) {
                    throw new Error(\`Server responded with status \${response.status}\`);
                }
                const data = await response.json();
                if (data && typeof data.next_order_number !== 'undefined') {
                    orderNumber = data.next_order_number;
                    if(elements.headerOrderNumber) elements.headerOrderNumber.textContent = orderNumber;
                }
            } catch (error) {
                console.error("Could not fetch next order number:", error);
                if(elements.headerOrderNumber) elements.headerOrderNumber.textContent = "Err";
                showToast("Could not sync order number with server.", "error");
            }
        }

        async function loadMenu() {
            if (demoMode) return; // Already handled in initializeAppState
            try {
                const response = await fetch('/api/menu');
                if (!response.ok) throw new Error(\`HTTP error! status: \${response.status}\`);
                menu = await response.json() || {};

                if (Object.keys(menu).length > 0 && (!selectedCategory || !menu[selectedCategory])) {
                    selectedCategory = Object.keys(menu)[0];
                } else if (Object.keys(menu).length === 0) {
                    selectedCategory = null;
                }
                renderCategories();
                populateManagementCategorySelect();
            } catch (error) {
                showToast(\`Error loading menu: \${error.message}\`, 'error');
                console.error("Load menu error:", error);
                if(elements.categoriesContainer) elements.categoriesContainer.innerHTML = '<p class="text-gray-500 italic">Could not load categories.</p>';
                if(elements.productsContainer) elements.productsContainer.innerHTML = '<p class="text-gray-500 italic col-span-full text-center">Could not load items.</p>';
            }
        }

        async function saveMenuToServer() {
            if (demoMode) {
                showToast("Saving is disabled in Demo Mode.", "info");
                return Promise.resolve(true);
            }
            try {
                const response = await fetch('/api/menu', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(menu)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({message: \`HTTP \${response.status} - \${response.statusText}\`}));
                    throw new Error(\`Failed to save menu: \${errorData.message}\`);
                }
                return true;
            } catch (error) {
                showToast(error.message, 'error');
                console.error("Save menu error:", error);
                return false;
            }
        }

        function renderCategories() {
            if (!elements.categoriesContainer) return;
            elements.categoriesContainer.innerHTML = '';

            if (Object.keys(menu).length === 0) {
                elements.categoriesContainer.innerHTML = '<p class="text-gray-500 italic">No categories defined.</p>';
                if (elements.productsContainer) {
                    elements.productsContainer.innerHTML = '<p class="text-gray-600 italic col-span-full text-center py-8">Please add categories and items in Management.</p>';
                }
                return;
            }

            const selectEl = document.createElement('select');
            selectEl.className = 'w-full p-2.5 border border-gray-400 rounded-md shadow-sm focus:ring-black focus:border-black text-gray-800 bg-white text-sm';
            selectEl.id = 'categorySelectorDropdown';

            Object.keys(menu).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                if (category === selectedCategory) {
                    option.selected = true;
                }
                selectEl.appendChild(option);
            });

            selectEl.onchange = (event) => {
                selectedCategory = event.target.value;
                renderProductsForSelectedCategory();
            };

            elements.categoriesContainer.appendChild(selectEl);

            if (selectedCategory && Object.keys(menu).includes(selectedCategory)) {
                 renderProductsForSelectedCategory();
            } else if (Object.keys(menu).length > 0 && selectEl.options.length > 0) {
                selectedCategory = selectEl.value;
                renderProductsForSelectedCategory();
            } else {
                 if (elements.productsContainer) elements.productsContainer.innerHTML = '<p class="text-gray-600 italic col-span-full text-center py-8">Select a category.</p>';
            }
        }

        function renderProductsForSelectedCategory() {
            if (!elements.productsContainer) return;
            elements.productsContainer.innerHTML = '';
            if (!selectedCategory || !menu[selectedCategory] || menu[selectedCategory].length === 0) {
                elements.productsContainer.innerHTML = \`<p class="text-gray-600 italic col-span-full text-center py-8">No items in "\${selectedCategory || 'this'}" category.</p>\`;
                return;
            }

            menu[selectedCategory].forEach(item => {
                const card = document.createElement('div');
                card.className = 'product-card bg-white rounded-lg shadow hover:shadow-md transition-shadow overflow-hidden flex flex-col cursor-pointer border border-gray-200';
                card.onclick = () => addToOrder(item.id);

                let badgeIconsHTML = '';
                const hasGenOptions = item.hasGeneralOptions && item.generalOptions && item.generalOptions.length > 0;

                let actualBadgeElements = [];
                if (hasGenOptions) {
                    actualBadgeElements.push(\`<span class="options-badge inline-flex items-center justify-center p-1 w-6 h-6 rounded"><i class="fas fa-cogs text-sm"></i></span>\`);
                }

                if (actualBadgeElements.length > 0) {
                    badgeIconsHTML = \`
                        <div class="absolute bottom-2 right-2 flex flex-col space-y-1">
                            \${actualBadgeElements.join('')}
                        </div>
                    \`;
                }

                card.innerHTML = \`
                    <div class="relative p-3 flex-grow flex flex-col h-full">
                        <div class="flex-grow flex flex-col pr-8"> 
                            <div class="flex-grow">
                                <h3 class="text-sm font-semibold text-gray-800 mb-1">\${item.name}</h3>
                            </div>
                            <div class="mt-auto">
                               <p class="text-lg font-bold text-black">€\${(item.price || 0).toFixed(2)}</p>
                            </div>
                        </div>
                        \${badgeIconsHTML}
                    </div>
                \`;
                elements.productsContainer.appendChild(card);
            });
        }
        
        function addToOrder(itemId) {
            let menuItem;
            for (const categoryKey in menu) {
                const found = (menu[categoryKey] || []).find(i => i.id === itemId);
                if (found) { menuItem = found; break; }
            }

            if (!menuItem) {
                console.error("Menu item not found for ID:", itemId);
                showToast("Error: Item not found.", 'error');
                return;
            }

            itemBeingConfigured = {...menuItem}; 
            currentOptionSelectionStep = null; 

            const hasGenOpts = (itemBeingConfigured.hasGeneralOptions && itemBeingConfigured.generalOptions && Array.isArray(itemBeingConfigured.generalOptions) && itemBeingConfigured.generalOptions.length > 0);

            if (hasGenOpts) {
                currentOptionSelectionStep = 'general';
                openItemOptionSelectModal(itemBeingConfigured, 'general_item_option');
            } else {
                finalizeAndAddOrderItem(itemBeingConfigured, []);
                resetMultiStepSelection();
            }
        }

        function finalizeAndAddOrderItem(baseItem, generalChoicesWithOptions) { 
            currentOrderLineItemCounter++;
            localStorage.setItem('pospalOrderLineItemCounter', currentOrderLineItemCounter.toString());

            let uniqueSuffixParts = [];
            if (generalChoicesWithOptions && generalChoicesWithOptions.length > 0) {
                 uniqueSuffixParts.push(...generalChoicesWithOptions.map(opt => opt.name.replace(/\\s+/g, '_')));
            }
            
            const uniqueLineIdSuffix = uniqueSuffixParts.length > 0 ? uniqueSuffixParts.join('-') : 'noopts';
            const uniqueLineId = \`\${baseItem.id}-\${uniqueLineIdSuffix}-line-\${currentOrderLineItemCounter}\`;

            let itemPriceWithModifiers = parseFloat(baseItem.price || 0);
            if (generalChoicesWithOptions && generalChoicesWithOptions.length > 0) {
                generalChoicesWithOptions.forEach(opt => {
                    itemPriceWithModifiers += parseFloat(opt.priceChange || 0);
                });
            }

            const orderItem = {
                ...baseItem, 
                quantity: 1,
                comment: "",
                orderId: uniqueLineId,
                generalSelectedOptions: generalChoicesWithOptions || [], 
                itemPriceWithModifiers: itemPriceWithModifiers 
            };
            currentOrder.push(orderItem);
            updateOrderDisplay();
        }
        
        function resetMultiStepSelection() {
            itemBeingConfigured = null;
            currentOptionSelectionStep = null;
        }


        function updateOrderDisplay() {
            if (!elements.orderItemsContainer || !elements.emptyOrderMessage) return;
            elements.orderItemsContainer.innerHTML = '';
            let total = 0;

            if (currentOrder.length === 0) {
                elements.emptyOrderMessage.style.display = 'block';
            } else {
                elements.emptyOrderMessage.style.display = 'none';
                currentOrder.forEach(item => {
                    const pricePerUnit = typeof item.itemPriceWithModifiers === 'number' ? item.itemPriceWithModifiers : parseFloat(item.price || 0);
                    const itemTotal = pricePerUnit * item.quantity;
                    total += itemTotal;

                    const div = document.createElement('div');
                    div.className = \`order-item p-2 border-b border-gray-200 flex items-center justify-between text-sm \${item.orderId === itemForNumpad?.orderId ? 'selected-for-numpad' : ''}\`;

                    let optionDisplayHTML = '';
                    if (item.generalSelectedOptions && item.generalSelectedOptions.length > 0) {
                        item.generalSelectedOptions.forEach(opt => {
                            const priceChangeDisplay = parseFloat(opt.priceChange || 0) !== 0 ? \` (\${parseFloat(opt.priceChange || 0) > 0 ? '+' : ''}€\${parseFloat(opt.priceChange || 0).toFixed(2)})\` : '';
                            optionDisplayHTML += \`<span class="block text-xs text-gray-600 ml-4">↳ \${opt.name}\${priceChangeDisplay}</span>\`;
                        });
                    }
                    let commentText = item.comment ? \`<span class="block text-xs text-gray-600 ml-4 break-all"><em>Note: \${item.comment}</em></span>\` : '';

                    div.innerHTML = \`
                        <div class="flex-grow pr-2">
                            <span class="font-medium text-gray-800">\${item.name}</span>
                            <span class="text-xs text-gray-500 ml-1">(Base: €\${parseFloat(item.price || 0).toFixed(2)})</span>
                            \${optionDisplayHTML}
                            \${commentText}
                        </div>
                        <div class="flex flex-col items-end space-y-1 flex-shrink-0">
                             <span class="font-semibold text-gray-800">€\${pricePerUnit.toFixed(2)} x \${item.quantity} = €\${itemTotal.toFixed(2)}</span>
                            <div class="flex items-center space-x-1">
                                <button onclick="decrementQuantity('\${item.orderId}')" class="p-1 text-gray-500 hover:text-red-600"><i class="fas fa-minus-circle"></i></button>
                                <span class="font-semibold text-gray-800 w-6 text-center cursor-pointer" onclick="openNumpadForOrderItem('\${item.orderId}', \${item.quantity}, '\${item.name.replace(/'/g, "\\\\'")}')">\${item.quantity}</span>
                                <button onclick="incrementQuantity('\${item.orderId}')" class="p-1 text-gray-500 hover:text-green-600"><i class="fas fa-plus-circle"></i></button>
                                <button onclick="promptForItemComment('\${item.orderId}')" class="p-1 text-gray-500 hover:text-black" title="Add Note"><i class="fas fa-comment-dots"></i></button>
                                <button onclick="removeItemByOrderId('\${item.orderId}')" class="p-1 text-red-500 hover:text-red-700" title="Remove Item"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                    \`;
                    elements.orderItemsContainer.appendChild(div);
                });
            }

            if(elements.orderTotalDisplay) elements.orderTotalDisplay.textContent = \`€\${total.toFixed(2)}\`;
            localStorage.setItem('pospalCurrentOrder', JSON.stringify(currentOrder));
            updateMobileOrderBadge();
        }

        function incrementQuantity(orderId) {
            const item = currentOrder.find(i => i.orderId === orderId);
            if (item) { item.quantity++; updateOrderDisplay(); }
        }

        function decrementQuantity(orderId) {
            const item = currentOrder.find(i => i.orderId === orderId);
            if (item) {
                item.quantity--;
                if (item.quantity <= 0) removeItemByOrderId(orderId);
                else updateOrderDisplay();
            }
        }

        function removeItemByOrderId(orderId) {
            currentOrder = currentOrder.filter(item => item.orderId !== orderId);
            if (itemForNumpad && itemForNumpad.orderId === orderId) hideNumpad();
            updateOrderDisplay();
            showToast('Item removed from order.', 'info');
        }

        function promptForItemComment(orderId) {
            const item = currentOrder.find(i => String(i.orderId) === orderId);
            if (item) {
                let currentSelectionDisplay = "";
                if (item.generalSelectedOptions && item.generalSelectedOptions.length > 0) {
                     currentSelectionDisplay += \` (Opt: \${item.generalSelectedOptions.map(opt => opt.name + (parseFloat(opt.priceChange || 0) !== 0 ? \` \${parseFloat(opt.priceChange || 0) > 0 ? '+' : ''}€\${parseFloat(opt.priceChange || 0).toFixed(2)}\` : '')).join(', ')})\`;
                }
                const newComment = prompt("Enter note for " + item.name + currentSelectionDisplay.trim() + ":", item.comment || "");
                if (newComment !== null) {
                    item.comment = newComment.trim();
                    updateOrderDisplay();
                }
            }
        }

        function clearOrderData() {
            currentOrder = [];
            universalOrderComment = "";
            if(elements.universalOrderCommentInput) elements.universalOrderCommentInput.value = "";
            localStorage.removeItem('pospalUniversalOrderComment');
            currentOrderLineItemCounter = 0;
            localStorage.setItem('pospalOrderLineItemCounter', '0');
            isPaidByCard = false;
            if(elements.paidByCardCheckbox) elements.paidByCardCheckbox.checked = false;

            hideNumpad();
            updateOrderDisplay();
            
            if (!demoMode) {
                fetchAndUpdateOrderNumber();
            } else {
                // In demo mode, just reset the number locally, don't increment
                orderNumber = 1; 
                if(elements.headerOrderNumber) elements.headerOrderNumber.textContent = orderNumber;
            }
        }
        
        function newOrder() {
            if (currentOrder.length > 0 && !confirm("Clear current order and start a new one? This will clear all items and notes.")) {
                return;
            }
            
            clearOrderData();
            showToast('Order cleared. Ready for the next order.', 'info');
        }

    async function sendOrder() {
        if(demoMode) {
            if (!currentOrder.length) {
                showToast('Order is empty!', 'warning');
                return;
            }
            if (!selectedTableNumber || selectedTableNumber.trim() === "") {
                showToast('Please enter a table number.', 'warning');
                return;
            }
            showToast(\`Order #\${orderNumber} Sent! (Demo Mode)\`, "success");
            clearOrderData();
            orderNumber++; // Increment for the next demo order
            if(elements.headerOrderNumber) elements.headerOrderNumber.textContent = orderNumber;
            return;
        }

        if (!elements.sendOrderBtn) return;

        if (!currentOrder.length) {
            showToast('Order is empty!', 'warning');
            return;
        }
        if (!selectedTableNumber || selectedTableNumber.trim() === "") {
            showToast('Please enter a table number.', 'warning');
            if (elements.headerTableNumberInput) {
                elements.headerTableNumberInput.focus();
                elements.headerTableNumberInput.classList.add('ring-2', 'ring-red-500');
                setTimeout(() => {
                     if(elements.headerTableNumberInput) elements.headerTableNumberInput.classList.remove('ring-2', 'ring-red-500');
                }, 2000);
            }
            return;
        }

        elements.sendOrderBtn.disabled = true;
        elements.sendOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Sending...';

        const orderData = {
            tableNumber: selectedTableNumber,
            items: currentOrder.map(item => ({
                id: item.id,
                name: item.name,
                basePrice: parseFloat(item.price || 0), 
                quantity: item.quantity,
                generalSelectedOptions: item.generalSelectedOptions || [], 
                itemPriceWithModifiers: item.itemPriceWithModifiers, 
                comment: item.comment || "",
            })),
            universalComment: universalOrderComment.trim(),
            paymentMethod: isPaidByCard ? 'Card' : 'Cash'
        };

        try {
            const response = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            const result = await response.json();

            if (response.ok) {
                if (result.status === "success") {
                    showToast(result.message || \`Order #\${result.order_number} sent, all copies printed, and logged!\`, 'success');
                } else if (result.status === "warning_print_copy2_failed") {
                    showToast(result.message || \`Order #\${result.order_number}: Copy 1 PRINTED & LOGGED. Copy 2 FAILED.\`, 'warning', 7000);
                } else if (result.status === "error_print_failed_copy1") {
                    showToast(result.message || \`Order #\${result.order_number} - COPY 1 FAILED. Order NOT saved.\`, 'error', 7000);
                } else if (result.status === "error_log_failed_after_print") {
                    showToast(result.message || \`Order #\${result.order_number} - PRINTED but LOGGING FAILED. Notify staff!\`, 'error', 10000);
                } else { 
                    showToast(result.message || \`Order #\${result.order_number} processed with issues: \${result.status}\`, 'warning', 7000);
                }

                if (result.status === "success" || result.status === "warning_print_copy2_failed" || result.status === "error_log_failed_after_print") {
                    clearOrderData();
                }

            } else {
                let errorMsg = \`Server error: \${response.status}.\`;
                if (result && result.message) {
                   errorMsg = result.message;
                } else {
                   try {
                       const errorText = await response.text();
                       errorMsg = \`Server error: \${response.status}\${errorText ? ' - ' + errorText.substring(0,100) : ''}.\`;
                   } catch (textError) { /* Ignore, use original errorMsg */ }
                }
                showToast(errorMsg + ' Order remains on screen.', 'error', 7000);
                fetchAndUpdateOrderNumber();
            }
        } catch (error) {
            console.error('Send order network/parse error:', error);
            let detailedErrorMsg = 'Network error or invalid server response. Could not send order.';
            if (error instanceof TypeError) {
                 detailedErrorMsg = 'Server returned an unexpected response format. Check server logs.';
            } else if (error.message) {
                detailedErrorMsg = \`Error: \${error.message}. Could not send order.\`;
            }
            showToast(detailedErrorMsg + ' Order remains on screen.', 'error', 7000);
            fetchAndUpdateOrderNumber();
        } finally {
            if(elements.sendOrderBtn) {
                elements.sendOrderBtn.disabled = false;
                elements.sendOrderBtn.innerHTML = '<i class="fas fa-paper-plane mr-1"></i> Send Order';
            }
        }
    }
    // ... all other functions (toggleMobileOrderPanel, updateMobileOrderBadge, numpad functions, etc.) remain here, but with demo checks for server functions
    // For brevity, I'll paste the remaining functions with their demo checks included.

        function toggleMobileOrderPanel() {
            isMobileOrderPanelOpen = !isMobileOrderPanelOpen;
            if (isMobileOrderPanelOpen) {
                elements.orderPanel.classList.remove('translate-y-full');
                elements.orderPanelBackdrop.classList.remove('hidden');
                if (elements.settingsGearContainer) elements.settingsGearContainer.classList.add('hidden');
                document.body.style.overflow = 'hidden';
            } else {
                elements.orderPanel.classList.add('translate-y-full');
                elements.orderPanelBackdrop.classList.add('hidden');
                if (elements.settingsGearContainer) elements.settingsGearContainer.classList.remove('hidden');
                document.body.style.overflow = '';
                hideNumpad();
            }
        }

        function updateMobileOrderBadge() {
            const count = currentOrder.reduce((sum, item) => sum + item.quantity, 0);
            if (elements.mobileOrderCountBadge) {
                if (count > 0) {
                    elements.mobileOrderCountBadge.textContent = count;
                    elements.mobileOrderCountBadge.classList.remove('hidden');
                } else {
                    elements.mobileOrderCountBadge.classList.add('hidden');
                }
            }
        }

        function openNumpadForOrderItem(orderId, currentQuantity, itemName) {
            itemForNumpad = { orderId, currentQuantity, itemName };
            numpadCurrentInput = currentQuantity.toString();
            if (elements.numpadItemNameDisplay) elements.numpadItemNameDisplay.innerHTML = \`Quantity for: <span class="font-bold">\${itemName}</span>\`;
            if (elements.numpadContainer) elements.numpadContainer.classList.remove('hidden');
            updateOrderDisplay();
        }

        function hideNumpad() {
            if (elements.numpadContainer) elements.numpadContainer.classList.add('hidden');
            itemForNumpad = null;
            numpadCurrentInput = "";
            updateOrderDisplay();
        }

        function handleNumpadInput(value) {
            if (!itemForNumpad) return;
            if (value === 'clear') {
                numpadCurrentInput = "";
            } else if (value === 'backspace') {
                numpadCurrentInput = numpadCurrentInput.slice(0, -1);
            } else if (numpadCurrentInput.length < 3) {
                numpadCurrentInput += value;
            }
        }

        function confirmNumpadInput() {
            if (!itemForNumpad) return;
            const newQuantity = parseInt(numpadCurrentInput);
            const item = currentOrder.find(i => i.orderId === itemForNumpad.orderId);

            if (item) {
                if (!isNaN(newQuantity) && newQuantity > 0) {
                    item.quantity = newQuantity;
                } else if (numpadCurrentInput === "" || newQuantity === 0) {
                    removeItemByOrderId(item.orderId);
                } else {
                    showToast("Invalid quantity. Please enter a number greater than 0.", "warning");
                }
            }
            hideNumpad();
        }

        let currentItemOptionContext = null; 

        function openItemOptionSelectModal(itemForModal, context) { 
            document.querySelectorAll('#optionModalOptionsContainer input').forEach(input => {
                input.checked = false;
                const parentDiv = input.closest('.option-selectable');
                if (parentDiv) parentDiv.classList.remove('selected', 'ring-2', 'ring-black', 'border-black', 'bg-gray-100');
            });
            currentItemOptionContext = context; 
            if (!elements.itemOptionSelectModal || !elements.optionModalItemName || !elements.optionModalOptionsContainer) return;

            elements.optionModalItemName.textContent = \`Options for: \${itemForModal.name}\`;
            elements.optionModalOptionsContainer.innerHTML = '';
            elements.confirmOptionBtn.disabled = true;

            let optionsToShow = [];
            let description = "";
            let inputType = 'radio';

            if (context === 'general_item_option') {
                optionsToShow = itemForModal.generalOptions || [];
                description = \`Select option(s) for \${itemForModal.name}. (Multiple selections allowed)\`;
                inputType = 'checkbox';
            } else {
                console.warn("Modal opened with unexpected context or item structure:", itemForModal, context);
                elements.optionModalOptionsContainer.innerHTML = \`<p class="text-sm text-gray-500">No suitable options for this step.</p>\`;
                elements.itemOptionSelectModal.classList.remove('hidden');
                elements.itemOptionSelectModal.classList.add('flex');
                return;
            }
            elements.optionModalItemDescription.textContent = description;

            if (optionsToShow.length > 0) {
                elements.confirmOptionBtn.disabled = false;
                optionsToShow.forEach((optionData, index) => { 
                    const optionName = (typeof optionData === 'object' && optionData.name) ? optionData.name : optionData;
                    const priceChange = (typeof optionData === 'object' && typeof optionData.priceChange === 'number') ? optionData.priceChange : 0;

                    const optionId = \`modal_item_opt_\${itemForModal.id}_\${context}_\${optionName.replace(/\\s+/g, '_')}_\${index}\`;
                    const div = document.createElement('div');
                    div.className = "option-selectable p-3 border border-gray-300 rounded-md hover:bg-gray-100 cursor-pointer group focus-within:ring-2 focus-within:ring-black";

                    const inputElement = document.createElement('input');
                    inputElement.type = inputType;
                    inputElement.name = \`item_option_for_\${itemForModal.id}_\${context}\`; 
                    if (inputType === 'checkbox') {
                        inputElement.name = optionId; 
                    }
                    inputElement.id = optionId;
                    inputElement.value = optionName; 
                    inputElement.dataset.priceChange = priceChange; 
                    inputElement.className = \`form-\${inputType} h-4 w-4 text-black border-gray-300 focus:ring-black accent-black\`;

                    let labelText = optionName;
                    if (inputType === 'checkbox' && priceChange !== 0) {
                        labelText += \` (\${priceChange > 0 ? '+' : ''}€\${priceChange.toFixed(2)})\`;
                    }

                    const label = document.createElement('label');
                    label.htmlFor = optionId;
                    label.textContent = labelText;
                    label.className = "ml-2 text-sm text-gray-700 cursor-pointer flex-grow";
                    
                    const innerFlex = document.createElement('div');
                    innerFlex.className = "flex items-center w-full";
                    innerFlex.appendChild(inputElement);
                    innerFlex.appendChild(label);
                    div.appendChild(innerFlex);
                    
                    div.onclick = function(event) {
                        if (event.target === inputElement || event.target === label || label.contains(event.target)) {
                           return; 
                        }
                        inputElement.click(); 
                    };

                    inputElement.addEventListener('change', function() {
                        const parentDiv = this.closest('.option-selectable');
                        if (!parentDiv) return;

                        if (this.type === 'radio') {
                            if (this.checked) {
                                elements.optionModalOptionsContainer.querySelectorAll('input[type="radio"][name="' + this.name + '"]').forEach(otherRadio => {
                                    const otherParentDiv = otherRadio.closest('.option-selectable');
                                    if (otherParentDiv && otherRadio !== this) {
                                        otherParentDiv.classList.remove('selected', 'ring-2', 'ring-black', 'border-black', 'bg-gray-100');
                                    }
                                });
                                parentDiv.classList.add('selected', 'ring-2', 'ring-black', 'border-black', 'bg-gray-100');
                            }
                        } else { 
                            if (this.checked) {
                                parentDiv.classList.add('selected', 'ring-2', 'ring-black', 'border-black', 'bg-gray-100');
                            } else {
                                parentDiv.classList.remove('selected', 'ring-2', 'ring-black', 'border-black', 'bg-gray-100');
                            }
                        }
                    });
                    
                    if (inputType === 'radio' && index === 0) { 
                        inputElement.checked = true;
                         setTimeout(() => { 
                            const parentDiv = inputElement.closest('.option-selectable');
                            if(parentDiv && inputElement.checked) { 
                                parentDiv.classList.add('selected', 'ring-2', 'ring-black', 'border-black', 'bg-gray-100');
                            }
                        }, 0);
                    }
                    elements.optionModalOptionsContainer.appendChild(div);
                });
            } else {
                elements.optionModalOptionsContainer.innerHTML = \`<p class="text-sm text-gray-500">No specific options defined for this item.</p>\`;
            }
            elements.itemOptionSelectModal.classList.remove('hidden');
            elements.itemOptionSelectModal.classList.add('flex');
        }

        function cancelOptionSelection() {
            if(elements.itemOptionSelectModal) {
                elements.itemOptionSelectModal.classList.add('hidden');
                elements.itemOptionSelectModal.classList.remove('flex');
            }
            currentItemOptionContext = null;
            resetMultiStepSelection(); 
        }

        function confirmOptionSelection() {
            if (!itemBeingConfigured || !elements.optionModalOptionsContainer || !currentItemOptionContext) {
                 console.error("State missing for confirmOptionSelection", itemBeingConfigured, currentItemOptionContext);
                 return;
            }

            if (currentItemOptionContext === 'general_item_option') {
                const checkedBoxes = elements.optionModalOptionsContainer.querySelectorAll('input[type="checkbox"]:checked');
                const generalSelectionsWithOptions = Array.from(checkedBoxes).map(cb => {
                    return {
                        name: cb.value,
                        priceChange: parseFloat(cb.dataset.priceChange || 0)
                    };
                });
                
                finalizeAndAddOrderItem(itemBeingConfigured, generalSelectionsWithOptions);
                resetMultiStepSelection();
                cancelOptionSelection(); 
            }
        }

        let currentManagementTab = 'items';
        let tempItemOptionsModal = []; 

        async function loadAppVersion() {
            if (demoMode) {
                if(elements.appVersion) elements.appVersion.textContent = 'Demo Version';
                return;
            }
            if (!elements.appVersion) return;
            try {
                const response = await fetch('/api/version');
                if (!response.ok) throw new Error('Failed to fetch version');
                const data = await response.json();
                elements.appVersion.textContent = data.version;
            } catch (error) {
                console.error("Error fetching app version:", error);
                elements.appVersion.textContent = 'N/A';
            }
        }

        function toggleManagementModal() {
            if (!elements.managementModal) return;
            const isActive = !elements.managementModal.classList.contains('hidden');
            if (isActive) {
                elements.managementModal.classList.add('hidden');
                elements.managementModal.classList.remove('flex');
            } else {
                elements.managementModal.classList.remove('hidden');
                elements.managementModal.classList.add('flex');
                loadManagementData();
                loadAppVersion();
                switchManagementTab('items', document.querySelector('.management-tab[onclick*="\\'items\\'"]')); 
            }
        }

        function switchManagementTab(tabName, clickedButton) {
            currentManagementTab = tabName;
            document.querySelectorAll('.management-tab').forEach(btn => {
                btn.classList.remove('bg-white', 'shadow-sm', 'text-gray-800');
                btn.classList.add('text-gray-600', 'hover:bg-gray-300');
            });
            if (clickedButton) {
                clickedButton.classList.add('bg-white', 'shadow-sm', 'text-gray-800');
                clickedButton.classList.remove('text-gray-600', 'hover:bg-gray-300');
            }

            const itemsView = document.getElementById('itemsManagement');
            const categoriesView = document.getElementById('categoriesManagement');
            const orderHistoryView = document.getElementById('orderHistoryManagement');

            if (!itemsView || !categoriesView || !orderHistoryView) return;

            itemsView.style.display = 'none';
            categoriesView.style.display = 'none';
            orderHistoryView.style.display = 'none';

            if (tabName === 'items') {
                itemsView.style.display = 'block';
                resetItemFormAndUIModal();
            } else if (tabName === 'categories') {
                categoriesView.style.display = 'block';
                if (elements.categoryNameInput) elements.categoryNameInput.value = '';
            } else if (tabName === 'orderHistory') {
                orderHistoryView.style.display = 'block';
                loadTodaysOrdersForReprint();
            }
        }

        function populateManagementCategorySelect() {
            if (!elements.itemCategorySelect) return;
            const currentCategoryValue = elements.itemCategorySelect.value;
            elements.itemCategorySelect.innerHTML = Object.keys(menu)
                .map(c => \`<option value="\${c}">\${c}</option>\`)
                .join('');
            if (Object.keys(menu).length === 0) {
                elements.itemCategorySelect.innerHTML = '<option value="">Create a category first</option>';
            } else if (currentCategoryValue && menu[currentCategoryValue]) {
                elements.itemCategorySelect.value = currentCategoryValue;
            } else if (elements.itemCategorySelect.options.length > 0) {
                 elements.itemCategorySelect.selectedIndex = 0;
            }
        }

        function loadManagementData() {
            populateManagementCategorySelect();
            renderExistingItemsInModal();
            renderExistingCategoriesInModal();
        }

        function renderExistingItemsInModal() {
            if (!elements.existingItemsListModal) return;
            elements.existingItemsListModal.innerHTML = '';
            let itemCount = 0;
            Object.entries(menu).forEach(([category, items]) => {
                (items || []).forEach(item => {
                    itemCount++;
                    const div = document.createElement('div');
                    div.className = \`p-2 border border-gray-300 rounded-md flex justify-between items-center text-sm \${editingItem && editingItem.id === item.id ? 'bg-gray-200 border-gray-500' : 'bg-white hover:bg-gray-50'}\`;

                    let itemDetails = \`<span class="font-medium text-gray-800">\${item.name}</span>
                                       <span class="text-xs text-gray-500 ml-1">(\${category}) - €\${(item.price || 0).toFixed(2)}</span>\`;

                    const hasGeneralOpts = item.hasGeneralOptions && item.generalOptions && item.generalOptions.length > 0;

                    if (hasGeneralOpts) { 
                        itemDetails += \`<span class="text-xs text-blue-600 ml-1">(Gen Opts: \${item.generalOptions.length})</span>\`;
                    }


                    div.innerHTML = \`
                        <div>\${itemDetails}</div>
                        <div class="space-x-1 flex-shrink-0">
                            <button onclick="editItemModal(\${item.id})" class="px-2 py-1 text-xs btn-warning text-white rounded hover:opacity-80">Edit</button>
                            <button onclick="deleteItem(\${item.id})" class="px-2 py-1 text-xs btn-danger text-white rounded hover:opacity-80">Delete</button>
                        </div>
                    \`;
                    elements.existingItemsListModal.appendChild(div);
                });
            });
            if (itemCount === 0) {
                 elements.existingItemsListModal.innerHTML = '<p class="text-xs text-gray-500 italic">No items created yet.</p>';
            }
        }

        function renderExistingCategoriesInModal() {
            if (!elements.existingCategoriesListModal) return;
            elements.existingCategoriesListModal.innerHTML = '';
            if (Object.keys(menu).length === 0) {
                elements.existingCategoriesListModal.innerHTML = '<p class="text-xs text-gray-500 italic">No categories created yet.</p>';
                return;
            }
            Object.keys(menu).forEach(categoryName => {
                const div = document.createElement('div');
                div.className = "p-2 border border-gray-300 rounded-md flex justify-between items-center text-sm bg-white hover:bg-gray-50";
                div.innerHTML = \`
                    <span class="font-medium text-gray-800">\${categoryName}</span>
                    <button onclick="deleteCategory('\${categoryName}')" class="px-2 py-1 text-xs btn-danger text-white rounded hover:opacity-80">Delete</button>
                \`;
                elements.existingCategoriesListModal.appendChild(div);
            });
        }

        function generateItemId() {
            const allItems = [].concat(...Object.values(menu).map(categoryItems => categoryItems || []));
            return allItems.length > 0 ? Math.max(0, ...allItems.map(i => i.id || 0)) + 1 : 1;
        }

        function resetItemFormAndUIModal() {
            if(elements.itemNameInput) elements.itemNameInput.value = '';
            if(elements.itemPriceInput) elements.itemPriceInput.value = '';
            if(elements.itemIdInput) elements.itemIdInput.value = ''; 
            if(elements.itemCategorySelect && elements.itemCategorySelect.options.length > 0) elements.itemCategorySelect.selectedIndex = 0;
            
            if(elements.itemHasOptionsCheckboxModal) elements.itemHasOptionsCheckboxModal.checked = false;
            tempItemOptionsModal = []; 

            if (elements.newOptionNameInputModal) elements.newOptionNameInputModal.value = '';
            if (elements.newOptionPriceInputModal) elements.newOptionPriceInputModal.value = '';

            toggleItemOptionsUIInModal(); 

            if(elements.saveItemBtn) elements.saveItemBtn.innerHTML = '💾 Save Item';
            if(elements.cancelEditBtn) elements.cancelEditBtn.classList.add('hidden');
            editingItem = null;
            renderExistingItemsInModal(); 
        }

        function editItemModal(itemIdToEdit) {
            let foundItem;
            let itemCategoryName;
            Object.entries(menu).forEach(([category, items]) => {
                const item = (items || []).find(i => i.id === itemIdToEdit);
                if (item) { foundItem = item; itemCategoryName = category; }
            });

            if (foundItem) {
                editingItem = { ...foundItem };
                if(elements.itemNameInput) elements.itemNameInput.value = foundItem.name;
                if(elements.itemPriceInput) elements.itemPriceInput.value = foundItem.price;
                if(elements.itemCategorySelect) elements.itemCategorySelect.value = itemCategoryName;
                if(elements.itemIdInput) elements.itemIdInput.value = foundItem.id; 

                if (foundItem.hasGeneralOptions && foundItem.generalOptions && Array.isArray(foundItem.generalOptions)) {
                    tempItemOptionsModal = [...foundItem.generalOptions];
                } else {
                    tempItemOptionsModal = [];
                }
                if(elements.itemHasOptionsCheckboxModal) {
                     elements.itemHasOptionsCheckboxModal.checked = (foundItem.hasGeneralOptions && tempItemOptionsModal.length > 0);
                }


                toggleItemOptionsUIInModal(); 

                if(elements.saveItemBtn) elements.saveItemBtn.innerHTML = '🔄 Update Item';
                if(elements.cancelEditBtn) elements.cancelEditBtn.classList.remove('hidden');
                renderExistingItemsInModal(); 
                if(elements.itemNameInput) elements.itemNameInput.focus();
            }
        }

        function cancelEditItem() {
            resetItemFormAndUIModal();
            showToast('Edit cancelled.', 'info');
        }

        async function saveItem() {
            if (!elements.itemNameInput || !elements.itemPriceInput || !elements.itemCategorySelect || !elements.itemHasOptionsCheckboxModal || !elements.itemIdInput) {
                console.error("A required form element is missing in \`elements\` cache for saveItem.");
                showToast('Error: Form elements missing. Cannot save.', 'error');
                return;
            }

            const itemName = elements.itemNameInput.value.trim();
            const itemPrice = parseFloat(elements.itemPriceInput.value); 
            const itemCategory = elements.itemCategorySelect.value;
            
            let itemIdVal;
            if (editingItem && elements.itemIdInput.value) {
                itemIdVal = parseInt(elements.itemIdInput.value);
                 if (isNaN(itemIdVal) || itemIdVal !== editingItem.id) { 
                    console.error("Item ID mismatch or invalid during edit. Expected:", editingItem.id, "Got:", elements.itemIdInput.value);
                    showToast('Error: Item ID conflict during update.', 'error');
                    return;
                 }
            } else if (editingItem) { 
                itemIdVal = editingItem.id;
            } else { 
                itemIdVal = generateItemId();
            }
            
            if (isNaN(itemIdVal)) {
                showToast('Error: Invalid Item ID. Cannot save.', 'error');
                return;
            }

            if (!itemName || isNaN(itemPrice) || itemPrice < 0) {
                showToast('Item Name and Base Price are required and Price must be valid.', 'warning'); return;
            }
             if (!itemCategory && Object.keys(menu).length > 0) {
                showToast('Please select a category for the item.', 'warning'); return;
            }
             if (Object.keys(menu).length === 0 && !itemCategory) {
                showToast('Please create a category first, then select it for the item.', 'warning'); return;
            }

            const itemData = {
                id: itemIdVal,
                name: itemName,
                price: itemPrice, 
                hasGeneralOptions: elements.itemHasOptionsCheckboxModal.checked,
                generalOptions: [] 
            };

            if (itemData.hasGeneralOptions) {
                if (tempItemOptionsModal.length === 0) {
                    showToast('If "Has General Options" is checked, please add at least one option.', 'warning'); return;
                }
                itemData.generalOptions = [...tempItemOptionsModal]; 
            } else {
                itemData.generalOptions = []; 
            }
            
            let oldCategoryOfItem = null;
            if (editingItem) { 
                Object.keys(menu).forEach(cat => {
                    const itemIndex = (menu[cat] || []).findIndex(i => i.id === editingItem.id);
                    if (itemIndex > -1) {
                        oldCategoryOfItem = cat;
                        if (cat !== itemCategory) { 
                           menu[cat].splice(itemIndex, 1); 
                        }
                    }
                });
            }

            if (!menu[itemCategory]) menu[itemCategory] = [];

            const existingItemIndexInTargetCategory = menu[itemCategory].findIndex(i => i.id === itemData.id);

            if (existingItemIndexInTargetCategory > -1) { 
                if (editingItem && editingItem.id === itemData.id) { 
                    menu[itemCategory][existingItemIndexInTargetCategory] = itemData; 
                } else if (!editingItem) { 
                     showToast('Error: Item ID conflict for new item. Please try again.', 'error');
                     return;
                }
                 else { 
                    showToast('Error: An item with this ID already exists in the target category.', 'error');
                    if (editingItem && oldCategoryOfItem && oldCategoryOfItem !== itemCategory && menu[oldCategoryOfItem]) {
                        menu[oldCategoryOfItem].push({...editingItem}); 
                    }
                    return; 
                }
            } else { 
                menu[itemCategory].push(itemData);
            }

            menu[itemCategory].sort((a, b) => a.name.localeCompare(b.name));

            const success = await saveMenuToServer();
            if (success) {
                showToast(editingItem ? 'Item updated successfully!' : 'Item saved successfully!', 'success');
                resetItemFormAndUIModal();
                if (demoMode) {
                    renderCategories();
                    populateManagementCategorySelect();
                } else {
                    loadMenu(); 
                }
            } else {
                showToast('Failed to save item to server. Reverting local changes.', 'error');
                loadMenu(); 
            }
        }

        async function deleteItem(itemIdToDelete) {
            if (!confirm('Are you sure you want to delete this item? This cannot be undone.')) return;

            let itemFoundAndDeletedLocally = false;
            let originalItemData = null;
            let originalCategory = null;

            Object.keys(menu).forEach(cat => {
                const itemIndex = (menu[cat] || []).findIndex(i => i.id === itemIdToDelete);
                if (itemIndex > -1) {
                    originalItemData = {...menu[cat][itemIndex]};
                    originalCategory = cat;
                    menu[cat].splice(itemIndex, 1);
                    itemFoundAndDeletedLocally = true;
                }
            });

            if (!itemFoundAndDeletedLocally) {
                showToast('Item not found for deletion.', 'warning'); return;
            }

            const success = await saveMenuToServer();
            if (success) {
                showToast('Item deleted successfully.', 'success');
                if (editingItem && editingItem.id === itemIdToDelete) resetItemFormAndUIModal();
                if (demoMode) {
                    renderCategories();
                    populateManagementCategorySelect();
                } else {
                    loadMenu();
                }
            } else {
                showToast('Failed to delete item on server. Reverting local deletion.', 'error');
                if (originalItemData && originalCategory && menu[originalCategory]) {
                    menu[originalCategory].push(originalItemData);
                    menu[originalCategory].sort((a,b) => a.name.localeCompare(b.name));
                }
                loadMenu();
            }
        }

        async function saveCategory() {
			if (!elements.categoryNameInput) return;
			const categoryName = elements.categoryNameInput.value.trim();
			if (!categoryName) { 
				showToast('Category name cannot be empty.', 'warning'); 
				return; 
			}
			if (menu[categoryName]) { 
				showToast('Category already exists.', 'warning'); 
				return; 
			}
            
            menu[categoryName] = [];
			
            const success = await saveMenuToServer();
            if(success) {
                showToast(\`Category "\${categoryName}" added successfully.\`, 'success');
                elements.categoryNameInput.value = '';
                if (demoMode) {
                    if (Object.keys(menu).length === 1) { selectedCategory = categoryName; }
                    renderCategories();
                    populateManagementCategorySelect();
                } else {
                    loadMenu();
                }
            } else {
                showToast(\`Failed to save category: \${error.message}\`, 'error');
                delete menu[categoryName]; // Revert change
            }
		}

        async function deleteCategory(categoryNameToDelete) {
            if (menu[categoryNameToDelete] && menu[categoryNameToDelete].length > 0) {
                if (!confirm(\`Category "\${categoryNameToDelete}" contains items. Are you sure you want to delete the category AND ALL ITS ITEMS? This cannot be undone.\`)) return;
            } else {
                if (!confirm(\`Are you sure you want to delete category "\${categoryNameToDelete}"? This cannot be undone.\`)) return;
            }
            const backupCategoryData = menu[categoryNameToDelete] ? [...menu[categoryNameToDelete]] : null;
            delete menu[categoryNameToDelete];

            const success = await saveMenuToServer();
            if (success) {
                showToast(\`Category "\${categoryNameToDelete}" deleted successfully.\`, 'success');
                if (selectedCategory === categoryNameToDelete) {
                    selectedCategory = Object.keys(menu)[0] || null;
                }
                 if (demoMode) {
                    renderCategories();
                    populateManagementCategorySelect();
                } else {
                    loadMenu();
                }
            } else {
                if(backupCategoryData !== null) menu[categoryNameToDelete] = backupCategoryData;
                showToast(\`Failed to delete category "\${categoryNameToDelete}" on server.\`, 'error');
                loadMenu();
            }
        }

        function toggleItemOptionsUIInModal() {
            const hasOptions = document.getElementById('itemHasOptionsModal').checked;
            document.getElementById('itemOptionsModalContainer').style.display = hasOptions ? 'block' : 'none';

            if(!hasOptions) {
                tempItemOptionsModal = [];
            }
            renderTemporaryOptionsListModal();
        }

        function addOptionToItemFormTempModal() {
            if (!elements.newOptionNameInputModal || !elements.newOptionPriceInputModal) return;
            const optionName = elements.newOptionNameInputModal.value.trim();
            const priceChangeText = elements.newOptionPriceInputModal.value.trim();
            const priceChange = priceChangeText === "" ? 0 : parseFloat(priceChangeText);

            if (!optionName) {
                showToast('Option name cannot be empty.', 'warning');
                return;
            }
            if (isNaN(priceChange)) {
                showToast('Price change must be a valid number or empty (for 0).', 'warning');
                return;
            }

            if (tempItemOptionsModal.find(opt => opt.name === optionName)) {
                showToast('This general option name already exists for the item.', 'warning');
                return;
            }
            
            tempItemOptionsModal.push({ name: optionName, priceChange: priceChange });
            renderTemporaryOptionsListModal();
            elements.newOptionNameInputModal.value = '';
            elements.newOptionPriceInputModal.value = '';
            elements.newOptionNameInputModal.focus();
        }

        function renderTemporaryOptionsListModal() {
            if (!elements.itemOptionsListDisplayModal) return;
            elements.itemOptionsListDisplayModal.innerHTML = '';
            if (tempItemOptionsModal.length === 0 && document.getElementById('itemHasOptionsModal').checked) {
                elements.itemOptionsListDisplayModal.innerHTML = '<p class="text-xs text-gray-500 italic w-full">No general options added yet.</p>';
                return;
            } else if (tempItemOptionsModal.length === 0 && !document.getElementById('itemHasOptionsModal').checked) {
                elements.itemOptionsListDisplayModal.innerHTML = '';
                return;
            }

            tempItemOptionsModal.forEach(opt => {
                const pillSpan = document.createElement('span');
                pillSpan.className = 'option-pill'; 
                const priceDisplay = parseFloat(opt.priceChange || 0) !== 0 ? \` (\${parseFloat(opt.priceChange || 0) > 0 ? '+' : ''}€\${parseFloat(opt.priceChange || 0).toFixed(2)})\` : '';
                pillSpan.textContent = \`\${opt.name}\${priceDisplay}\`;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-option-btn'; 
                removeBtn.innerHTML = '&times;'; 
                removeBtn.title = \`Remove option: \${opt.name}\`;
                removeBtn.type = 'button'; 
                removeBtn.onclick = () => removeTemporaryOptionModal(opt.name);
                pillSpan.appendChild(removeBtn);
                elements.itemOptionsListDisplayModal.appendChild(pillSpan);
            });
        }
        function removeTemporaryOptionModal(optionNameToRemove) { 
            tempItemOptionsModal = tempItemOptionsModal.filter(opt => opt.name !== optionNameToRemove);
            renderTemporaryOptionsListModal();
        }

        let toastTimeout;
        function showToast(message, type = 'info', duration = 3000) {
            if (!elements.toast || !elements.toastMessage) return;
            clearTimeout(toastTimeout);
            elements.toastMessage.textContent = message;

            elements.toast.className = 'fixed top-5 right-5 text-white px-4 py-2 rounded-md shadow-lg text-sm z-[100] opacity-0 transition-opacity duration-300';

            switch(type) {
                case 'success': elements.toast.classList.add('bg-green-600'); break;
                case 'warning': elements.toast.classList.add('bg-yellow-500'); break;
                case 'error': elements.toast.classList.add('bg-red-600'); break;
                default: elements.toast.classList.add('bg-gray-800');
            }

            elements.toast.classList.remove('hidden');
            setTimeout(() => elements.toast.classList.remove('opacity-0'), 10);

            toastTimeout = setTimeout(() => {
                elements.toast.classList.add('opacity-0');
                setTimeout(() => elements.toast.classList.add('hidden'), 300);
            }, duration);
        }

        function prepareKitchenTicketData() {
            const ticketNumEl = document.getElementById('ticket-order-number');
            const ticketItemsEl = document.getElementById('ticket-items');
            const ticketNotesEl = document.getElementById('ticket-notes-content');
            const ticketTimeEl = document.getElementById('ticket-time');

            if(ticketNumEl) ticketNumEl.textContent = orderNumber;
            if(ticketTimeEl) ticketTimeEl.textContent = new Date().toLocaleString(navigator.language || 'en-US');

            if(ticketItemsEl) {
                ticketItemsEl.innerHTML = currentOrder.map(item => {
                    let optionStr = '';
                    if (item.generalSelectedOptions && item.generalSelectedOptions.length > 0) {
                        optionStr += \` (Opt: \${item.generalSelectedOptions.map(opt => opt.name).join(', ')})\`;
                    }
                    return \`<div>\${item.quantity}x \${item.name}\${optionStr.trim()}\${item.comment ? \` <small><em>(\${item.comment})</em></small>\` : ''}</div>\`
                }).join('');
            }
            if(ticketNotesEl) ticketNotesEl.textContent = universalOrderComment || "None";
        }

        async function loadTodaysOrdersForReprint() {
            if (demoMode) {
                elements.todaysOrdersList.innerHTML = '<p class="text-xs text-gray-500 italic">Order history is disabled in Demo Mode.</p>';
                return;
            }
            if (!elements.todaysOrdersList) return;
            elements.todaysOrdersList.innerHTML = '<p class="text-xs text-gray-500 italic">Loading today\\'s orders...</p>';
            try {
                const response = await fetch('/api/todays_orders_for_reprint');
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: \`HTTP \${response.status}\` }));
                    throw new Error(errorData.message || \`Failed to load orders: \${response.statusText}\`);
                }
                const orders = await response.json();
                renderTodaysOrdersList(orders);
            } catch (error) {
                console.error("Error loading today's orders for reprint:", error);
                elements.todaysOrdersList.innerHTML = \`<p class="text-xs text-red-500 italic">Error loading orders: \${error.message}. Try refreshing.</p>\`;
                showToast(\`Error loading orders: \${error.message}\`, 'error');
            }
        }

        function renderTodaysOrdersList(orders) {
            if (!elements.todaysOrdersList) return;
            elements.todaysOrdersList.innerHTML = '';

            if (!orders || orders.length === 0) {
                elements.todaysOrdersList.innerHTML = '<p class="text-xs text-gray-500 italic">No orders found for today.</p>';
                return;
            }

            orders.forEach(order => {
                const div = document.createElement('div');
                div.className = "p-2.5 border border-gray-300 rounded-md flex justify-between items-center text-sm bg-white hover:bg-gray-50";
                
                let formattedTimestamp = order.timestamp;
                try {
                    const dateObj = new Date(order.timestamp);
                    if (!isNaN(dateObj)) {
                         formattedTimestamp = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    }
                } catch(e) { /* keep original if parsing fails */ }


                div.innerHTML = \`
                    <div>
                        <span class="font-semibold text-gray-800">Order #\${order.order_number}</span>
                        <span class="text-xs text-gray-600 ml-2">Table: \${order.table_number || 'N/A'}</span>
                        <span class="text-xs text-gray-500 ml-2">Time: \${formattedTimestamp}</span>
                    </div>
                    <button onclick="reprintOrder('\${order.order_number}')" class="px-3 py-1.5 text-xs btn-primary text-white rounded hover:opacity-80 transition">
                        <i class="fas fa-print mr-1"></i> Reprint
                    </button>
                \`;
                elements.todaysOrdersList.appendChild(div);
            });
        }

        async function reprintOrder(orderNumToReprint) {
            if(demoMode) {
                showToast(\`Reprinting Order #\${orderNumToReprint} (Demo Mode)\`, "success");
                return;
            }
            if (!orderNumToReprint) {
                showToast('Invalid order number for reprint.', 'error');
                return;
            }

            const reprintButton = event.target.closest('button');
            if (reprintButton) {
                reprintButton.disabled = true;
                reprintButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Reprinting...';
            }

            try {
                const response = await fetch('/api/reprint_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_number: orderNumToReprint })
                });
                const result = await response.json();

                if (response.ok) {
                    if (result.status === "success") {
                        showToast(result.message || \`Order #\${orderNumToReprint} REPRINTED successfully!\`, 'success');
                    } else if (result.status === "warning_reprint_copy2_failed") {
                        showToast(result.message || \`Order #\${orderNumToReprint}: Kitchen REPRINTED. Copy 2 FAILED.\`, 'warning', 7000);
                    } else { 
                        showToast(result.message || \`Failed to reprint Order #\${orderNumToReprint}.\`, 'error', 7000);
                    }
                } else { 
                     showToast(result.message || \`Server error during reprint of Order #\${orderNumToReprint}: \${response.status}.\`, 'error', 7000);
                }

            } catch (error) {
                console.error(\`Error reprinting order \${orderNumToReprint}:\`, error);
                showToast(\`Network error or invalid response while reprinting Order #\${orderNumToReprint}.\`, 'error', 7000);
            } finally {
                 if (reprintButton) {
                    reprintButton.disabled = false;
                    reprintButton.innerHTML = '<i class="fas fa-print mr-1"></i> Reprint';
                }
            }
        }

        async function openDaySummaryModal() {
            if (!elements.daySummaryModal || !elements.daySummaryContent) return;
            elements.daySummaryModal.classList.remove('hidden');
            elements.daySummaryModal.classList.add('flex');
            
            if (demoMode) {
                renderDaySummary({
                    status: 'success',
                    total_orders: 15,
                    cash_total: 157.50,
                    card_total: 242.00,
                    grand_total: 399.50
                });
                return;
            }

            elements.daySummaryContent.innerHTML = '<p class="text-center italic">Loading summary...</p>';

            try {
                const response = await fetch('/api/daily_summary');
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || \`Server error: \${response.status}\`);
                }
                const summary = await response.json();
                renderDaySummary(summary);
            } catch (error) {
                elements.daySummaryContent.innerHTML = \`<p class="text-center text-red-500">Error loading summary: \${error.message}</p>\`;
            }
        }

        function closeDaySummaryModal() {
            if (!elements.daySummaryModal) return;
            elements.daySummaryModal.classList.add('hidden');
            elements.daySummaryModal.classList.remove('flex');
        }

        function renderDaySummary(summary) {
            if (!elements.daySummaryContent) return;
            
            if (summary.status === 'error') {
                elements.daySummaryContent.innerHTML = \`<p class="text-center text-red-500">\${summary.message}</p>\`;
                return;
            }

            elements.daySummaryContent.innerHTML = \`
                <div class="space-y-3 text-base">
                    <div class="flex justify-between items-center py-2 border-b">
                        <span class="font-medium text-gray-600">Total Orders:</span>
                        <span class="font-semibold text-gray-800">\${summary.total_orders}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b">
                        <span class="font-medium text-gray-600">Total Cash Payments:</span>
                        <span class="font-semibold text-green-600">€\${summary.cash_total.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b">
                        <span class="font-medium text-gray-600">Total Card Payments:</span>
                        <span class="font-semibold text-blue-600">€\${summary.card_total.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center pt-3 mt-2 border-t-2 border-black">
                        <span class="text-lg font-bold text-gray-900">Grand Total:</span>
                        <span class="text-lg font-bold text-gray-900">€\${summary.grand_total.toFixed(2)}</span>
                    </div>
                </div>
            \`;
        }
            `;
        }
    </script>
</body>
</html>
