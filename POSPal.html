<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POSPal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #6b7280;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }

        .product-card h3 {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.5em; /* Roughly 2 lines for text-sm */
        }
        
        .options-badge {
            font-weight: 500;
            color: white;
            border-radius: 3px; 
            white-space: nowrap;
            background-color: #4b5563; 
        }

        .option-pill {
            display: inline-flex;
            align-items: center;
            background-color: #4b5563;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 16px;
            font-size: 0.9em;
            line-height: 1;
        }
        .option-pill .remove-option-btn {
            background: none;
            border: none;
            color: white;
            margin-left: 0.6rem;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            line-height: 0.5;
            font-weight: bold;
        }
         .option-pill .remove-option-btn:hover {
            color: #d1d5db;
        }

        .order-item.selected-for-numpad {
            background-color: #e5e7eb;
            border-left: 3px solid #374151;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #111827;
            box-shadow: 0 0 0 2px #9ca3af;
            outline: none;
        }
        .management-form input:focus, .management-form select:focus, .management-form textarea:focus {
             border-color: #111827;
            box-shadow: 0 0 0 2px #9ca3af;
        }

        .btn-primary {
            background-color: #111827;
            color: white;
        }
        .btn-primary:hover {
            background-color: #1f2937;
        }
        .btn-primary:disabled {
            background-color: #6b7280;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
            border: 1px solid #d1d5db;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-warning {
             background-color: #f59e0b;
             color: white;
        }
        .btn-warning:hover {
            background-color: #d97706;
        }
        .btn-success {
            background-color: #16a34a;
            color: white;
        }
        .btn-success:hover {
            background-color: #15803d;
        }

        .management-tab-container {
            position: relative;
            z-index: 10;
        }
        .management-content {
            position: relative;
            z-index: 1;
        }
        .option-selectable.selected {
            border-color: #111827 !important; 
            background-color: #f3f4f6; 
        }
        .date-range-btn.active {
            background-color: #111827;
            color: white;
            font-weight: 600;
        }
        /* Style for the copy button */
        .copy-btn {
            background-color: #d1d5db;
            color: #1f2937;
            border: 1px solid #9ca3af;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .copy-btn:hover {
            background-color: #9ca3af;
        }
    </style>
</head>
<body class="bg-white text-gray-800">

    <div id="main-content" class="pb-28"> 
        <!-- ENHANCED HEADER -->
        <header class="bg-gray-900 text-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <!-- Left Side: App Name -->
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold tracking-wider">POS<span class="text-green-400">Pal</span></h1>
                </div>

                <!-- Right Side: Clock, Order Info, Table Selection -->
                <div class="flex items-center space-x-4">
                    <div id="realtime-clock" class="hidden sm:block text-sm text-gray-300 font-mono"></div>
                    <div class="text-right">
                        <div class="text-xs text-gray-400">Order #<span id="header-order-number" class="font-semibold">...</span></div>
                        <!-- EFFICIENT TABLE INPUT -->
                        <div id="header-table-container" class="mt-1 flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 transition-colors px-3 py-1 rounded-md">
                            <label for="header-table-input" class="cursor-pointer">
                                <i class="fas fa-chair text-white"></i>
                            </label>
                            <input type="text" id="header-table-input" class="bg-transparent text-white font-semibold w-24 focus:outline-none placeholder-gray-400" placeholder="Table #">
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <section id="category-section" class="py-3 bg-white border-b border-gray-300 sticky top-[68px] z-30"> <div class="container mx-auto px-4">
                <div id="categories" class="flex space-x-2 overflow-x-auto pb-2"> <p class="text-gray-500 italic">Loading categories...</p>
                </div>
            </div>
        </section>

        <section id="product-section" class="py-4 bg-gray-50">
            <div class="container mx-auto px-4">
                <div id="products" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                    <p class="text-gray-500 italic col-span-full text-center">Select a category to see items.</p>
                </div>
            </div>
        </section>
    </div>

    <button id="mobile-order-toggle" onclick="toggleMobileOrderPanel()" class="fixed bottom-4 right-4 bg-black text-white p-4 rounded-full shadow-lg z-50 flex items-center justify-center hover:bg-gray-800 active:bg-gray-700">
        <i class="fas fa-receipt text-xl"></i>
        <span id="mobile-order-count-badge" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
    </button>

    <div id="order-panel-backdrop" class="fixed inset-0 bg-black bg-opacity-60 z-40 hidden" onclick="toggleMobileOrderPanel()"></div>
    <aside id="order-panel" class="fixed bottom-0 left-0 right-0 bg-white shadow-2xl border-t-2 border-black transform translate-y-full transition-transform duration-300 ease-in-out z-50 flex flex-col" style="max-height: 85vh;">
        <div class="p-3 border-b border-gray-300 flex justify-between items-center bg-gray-100">
            <h2 class="text-lg font-semibold text-gray-800">Your Order</h2>
            <button onclick="toggleMobileOrderPanel()" class="text-gray-600 hover:text-black">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div id="order-items-container" class="flex-grow overflow-y-auto p-3 space-y-2 bg-white">
            <p id="empty-order-message" class="text-gray-600 text-center py-4">Your order is empty.</p>
            </div>

        <div id="numpad-container" class="p-3 border-t border-gray-300 bg-gray-100 hidden">
            <p id="numpad-item-name" class="text-sm text-center font-medium text-gray-700 mb-2">Quantity for: <span class="font-bold">Item</span></p>
            <div class="grid grid-cols-3 gap-2">
                <button onclick="handleNumpadInput('1')" class="py-3 bg-white border border-gray-400 rounded-md text-gray-800 font-semibold hover:bg-gray-200 active:bg-gray-300">1</button>
                <button onclick="handleNumpadInput('2')" class="py-3 bg-white border border-gray-400 rounded-md text-gray-800 font-semibold hover:bg-gray-200 active:bg-gray-300">2</button>
                <button onclick="handleNumpadInput('3')" class="py-3 bg-white border border-gray-400 rounded-md text-gray-800 font-semibold hover:bg-gray-200 active:bg-gray-300">3</button>
                <button onclick="handleNumpadInput('4')" class="py-3 bg-white border border-gray-400 rounded-md text-gray-800 font-semibold hover:bg-gray-200 active:bg-gray-300">4</button>
                <button onclick="handleNumpadInput('5')" class="py-3 bg-white border border-gray-400 rounded-md text-gray-800 font-semibold hover:bg-gray-200 active:bg-gray-300">5</button>
                <button onclick="handleNumpadInput('6')" class="py-3 bg-white border border-gray-400 rounded-md text-gray-800 font-semibold hover:bg-gray-200 active:bg-gray-300">6</button>
                <button onclick="handleNumpadInput('7')" class="py-3 bg-white border border-gray-400 rounded-md text-gray-800 font-semibold hover:bg-gray-200 active:bg-gray-300">7</button>
                <button onclick="handleNumpadInput('8')" class="py-3 bg-white border border-gray-400 rounded-md text-gray-800 font-semibold hover:bg-gray-200 active:bg-gray-300">8</button>
                <button onclick="handleNumpadInput('9')" class="py-3 bg-white border border-gray-400 rounded-md text-gray-800 font-semibold hover:bg-gray-200 active:bg-gray-300">9</button>
                <button onclick="handleNumpadInput('clear')" class="py-3 bg-gray-300 text-black rounded-md font-semibold hover:bg-gray-400 active:bg-gray-500">C</button>
                <button onclick="handleNumpadInput('0')" class="py-3 bg-white border border-gray-400 rounded-md text-gray-800 font-semibold hover:bg-gray-200 active:bg-gray-300">0</button>
                <button onclick="handleNumpadInput('backspace')" class="py-3 bg-gray-300 text-black rounded-md font-semibold hover:bg-gray-400 active:bg-gray-500"><i class="fas fa-backspace"></i></button>
            </div>
            <button onclick="confirmNumpadInput()" class="mt-2 w-full py-2 btn-primary rounded-md font-semibold">Done</button>
        </div>

        <div class="p-3 border-t border-gray-300 bg-gray-100 space-y-3">
            <div>
                <label for="universalOrderCommentInput" class="block text-xs font-medium text-gray-700 mb-1">Order Notes:</label>
                <textarea id="universalOrderCommentInput" rows="2" class="w-full p-2 border border-gray-400 rounded-md text-sm" placeholder="Any special requests for the whole order?"></textarea>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-lg font-semibold text-gray-800">Total:</span>
                <span id="order-total" class="text-lg font-bold text-black">€0.00</span>
            </div>
            <div class="flex justify-between items-center">
                <label for="paidByCardCheckbox" class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" id="paidByCardCheckbox" class="h-5 w-5 text-black border-gray-400 rounded focus:ring-black accent-black">
                    <span class="text-sm font-medium text-gray-700">Pay by Card</span>
                </label>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="newOrder()" class="w-full py-3 btn-secondary transition">
                    <i class="fas fa-eraser mr-1"></i> New Order
                </button>
                <button id="sendOrderBtn" onclick="sendOrder()" class="w-full py-3 btn-primary transition">
                    <i class="fas fa-paper-plane mr-1"></i> Send Order
                </button>
            </div>
        </div>
    </aside>

    <div id="settings-gear-container" class="fixed bottom-20 right-4 z-40"> <button onclick="openLoginModal()" class="bg-gray-700 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center hover:bg-gray-800 transition" title="Settings">
            <i class="fas fa-cog text-xl"></i>
        </button>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-70 z-[90] hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-gray-800">
            <h3 class="text-xl font-semibold mb-4 text-center">Management Access</h3>
            <form id="loginForm">
                <div class="space-y-4">
                    <div>
                        <label for="passwordInput" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="passwordInput" name="password" class="mt-1 block w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm sm:text-sm" required>
                    </div>
                    <p id="loginError" class="text-sm text-red-600 text-center hidden"></p>
                    <div class="flex gap-2 pt-2">
                        <button type="button" class="w-full py-2 px-4 btn-secondary" onclick="closeLoginModal()">Cancel</button>
                        <button type="submit" id="loginSubmitBtn" class="w-full py-2 px-4 btn-primary">Login</button>
                    </div>
                </div>
            </form>
        </div>
    </div>


    <div id="itemOptionSelectModal" class="fixed inset-0 bg-black bg-opacity-70 z-[60] hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-5 w-full max-w-md max-h-[80vh] flex flex-col text-gray-800">
            <h3 id="optionModalItemName" class="text-lg font-semibold mb-1">Select Option</h3>
            <p id="optionModalItemDescription" class="text-sm text-gray-600 mb-3">Please choose an option for the selected item:</p>
            <div id="optionModalOptionsContainer" class="flex-grow overflow-y-auto space-y-2 mb-4 pr-1">
                </div>
            <div class="flex gap-2 mt-auto">
                <button type="button" class="w-full py-2 px-4 btn-secondary" onclick="cancelOptionSelection()">Cancel</button>
                <button type="button" id="confirmOptionBtn" class="w-full py-2 px-4 btn-primary" onclick="confirmOptionSelection()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Main Management Modal (IMPROVED) -->
    <div id="managementModal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden flex flex-col justify-end sm:justify-center sm:items-center">
        <div class="bg-white shadow-xl w-full h-[90vh] sm:h-auto sm:max-h-[90vh] sm:max-w-6xl flex flex-col text-gray-800 rounded-t-2xl sm:rounded-lg">
            <!-- Header -->
            <div class="p-4 border-b border-gray-200 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-semibold">Management</h2>
                <button onclick="closeManagementModal()" class="text-gray-500 hover:text-black"><i class="fas fa-times text-2xl"></i></button>
            </div>

            <!-- Tabs -->
            <div class="p-2 border-b border-gray-200 management-tab-container flex-shrink-0">
                <div class="flex flex-wrap gap-1 rounded-md bg-gray-100 p-1">
                    <button onclick="switchManagementTab('analytics', this)" class="management-tab flex-1 py-2 px-2 text-xs sm:text-sm font-medium rounded-md bg-white shadow-sm text-gray-800">Analytics</button>
                    <button onclick="switchManagementTab('items', this)" class="management-tab flex-1 py-2 px-2 text-xs sm:text-sm font-medium rounded-md text-gray-600 hover:bg-gray-200">Items</button>
                    <button onclick="switchManagementTab('categories', this)" class="management-tab flex-1 py-2 px-2 text-xs sm:text-sm font-medium rounded-md text-gray-600 hover:bg-gray-200">Categories</button>
                    <button onclick="switchManagementTab('orderHistory', this)" class="management-tab flex-1 py-2 px-2 text-xs sm:text-sm font-medium rounded-md text-gray-600 hover:bg-gray-200">Order History</button>
                    <!-- NEW: License Tab Button -->
                    <button onclick="switchManagementTab('license', this)" class="management-tab flex-1 py-2 px-2 text-xs sm:text-sm font-medium rounded-md text-gray-600 hover:bg-gray-200">License</button>
                    <button onclick="openDaySummaryModal()" class="flex-1 py-2 px-2 text-xs sm:text-sm font-medium rounded-md text-gray-600 hover:bg-gray-200 bg-blue-100">Day Summary</button>
                </div>
            </div>

            <!-- Content -->
            <div class="flex-grow overflow-y-auto p-4 management-content">
                <!-- Analytics View -->
                <div id="analyticsManagement">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                        <h3 class="text-xl font-semibold text-gray-800">Performance Overview</h3>
                        <div class="flex items-center gap-1 bg-gray-100 p-1 rounded-lg flex-wrap">
                            <button onclick="loadAnalyticsData('today', this)" class="date-range-btn flex-grow text-sm px-3 py-1.5 rounded-md transition-colors">Today</button>
                            <button onclick="loadAnalyticsData('week', this)" class="date-range-btn flex-grow text-sm px-3 py-1.5 rounded-md transition-colors">This Week</button>
                            <button onclick="loadAnalyticsData('month', this)" class="date-range-btn flex-grow text-sm px-3 py-1.5 rounded-md transition-colors">This Month</button>
                            <button onclick="toggleCustomDateRangeUI(this)" class="date-range-btn flex-grow text-sm px-3 py-1.5 rounded-md transition-colors">Custom</button>
                        </div>
                    </div>

                    <!-- Custom Date Range Picker -->
                    <div id="custom-date-range-picker" class="hidden my-4 p-4 bg-gray-100 rounded-lg border border-gray-200">
                        <div class="flex flex-col sm:flex-row items-center gap-4">
                            <div>
                                <label for="startDate" class="block text-sm font-medium text-gray-700">Start Date</label>
                                <input type="date" id="startDate" name="startDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                            </div>
                            <div>
                                <label for="endDate" class="block text-sm font-medium text-gray-700">End Date</label>
                                <input type="date" id="endDate" name="endDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                            </div>
                            <div class="self-end pt-1 sm:pt-0">
                                <button onclick="fetchCustomDateRangeAnalytics()" class="w-full sm:w-auto py-2 px-4 btn-primary rounded-md">Go</button>
                            </div>
                        </div>
                    </div>

                    <!-- KPI Cards Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div class="bg-gray-50 p-4 rounded-lg shadow">
                            <h4 class="text-sm font-medium text-gray-500">Gross Revenue</h4>
                            <p id="kpi-gross-revenue" class="text-3xl font-bold text-gray-900 mt-1">€0.00</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg shadow">
                            <h4 class="text-sm font-medium text-gray-500">Total Orders</h4>
                            <p id="kpi-total-orders" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg shadow">
                            <h4 class="text-sm font-medium text-gray-500">Avg. Order Value</h4>
                            <p id="kpi-atv" class="text-3xl font-bold text-gray-900 mt-1">€0.00</p>
                        </div>
                         <div class="bg-gray-50 p-4 rounded-lg shadow">
                            <h4 class="font-semibold text-gray-700 mb-2">Payment Methods</h4>
                            <div class="space-y-2 mt-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600"><i class="fas fa-money-bill-wave mr-2 text-green-500"></i>Cash</span>
                                    <span id="kpi-payment-cash" class="font-bold text-gray-800">€0.00</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600"><i class="far fa-credit-card mr-2 text-blue-500"></i>Card</span>
                                    <span id="kpi-payment-card" class="font-bold text-gray-800">€0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Deeper Dive Sections -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <!-- Section: Sales by Hour Chart -->
                        <div class="bg-white p-4 rounded-lg border lg:col-span-2">
                             <h4 class="font-semibold text-gray-700 mb-3">Sales by Hour</h4>
                             <!-- Wrapper to allow horizontal scrolling on smaller screens -->
                             <div class="overflow-x-auto pb-2">
                                 <div id="analytics-chart-container" class="h-64 flex items-end space-x-4">
                                     <p class="text-xs text-gray-500 italic w-full text-center">Loading chart data...</p>
                                 </div>
                             </div>
                        </div>
                        
                        <!-- Section: Sales by Category -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-700 mb-2">Sales by Category</h4>
                            <div id="kpi-sales-by-category" class="space-y-2 max-h-64 overflow-y-auto">
                                <p class="text-xs text-gray-500 italic">Loading data...</p>
                            </div>
                        </div>

                        <!-- Section: Top Items by Revenue -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-700 mb-2">Top Items (by Revenue)</h4>
                            <div id="kpi-top-revenue-items" class="space-y-2 max-h-48 overflow-y-auto">
                                <p class="text-xs text-gray-500 italic">Loading data...</p>
                            </div>
                        </div>
                        
                        <!-- Section: Best Selling Items -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-700 mb-2">Best Selling Items (by Qty)</h4>
                            <div id="kpi-best-sellers" class="space-y-2 max-h-48 overflow-y-auto">
                                <p class="text-xs text-gray-500 italic">Loading data...</p>
                            </div>
                        </div>

                        <!-- Section: Underperforming Items -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-700 mb-2">Underperforming Items (by Qty)</h4>
                            <div id="kpi-worst-sellers" class="space-y-2 max-h-48 overflow-y-auto">
                                <p class="text-xs text-gray-500 italic">Loading data...</p>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Items Management View -->
                <div id="itemsManagement" class="hidden">
                    <div class="flex justify-end mb-4">
                        <button onclick="openItemFormModal()" class="btn-success py-2 px-4 rounded-md flex items-center">
                            <i class="fas fa-plus mr-2"></i>Add New Item
                        </button>
                    </div>
                    <h4 class="text-md font-medium text-gray-800 mb-2">Existing Items</h4>
                    <div id="existingItemsListModal" class="space-y-3 pr-2 border border-gray-200 rounded-md p-2 bg-gray-50">
                       <p class="text-xs text-gray-500 italic">No items found.</p>
                    </div>
                </div>

                <!-- Categories Management View -->
                <div id="categoriesManagement" class="hidden">
                    <form id="categoryManagementForm" class="space-y-4 management-form">
                        <div>
                            <label for="categoryName" class="block text-sm font-medium text-gray-700">Category Name</label>
                            <input type="text" id="categoryName" name="categoryName" class="mt-1 block w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm sm:text-sm" required>
                        </div>
                        <button type="button" onclick="saveCategory()" class="w-full py-2 px-4 btn-success">📁 Save Category</button>
                    </form>
                     <div class="mt-6">
                        <h4 class="text-md font-medium text-gray-800 mb-2">Existing Categories</h4>
                        <div id="existingCategoriesListModal" class="space-y-2 max-h-72 overflow-y-auto pr-1 border border-gray-200 rounded-md p-2 bg-gray-50">
                            <p class="text-xs text-gray-500 italic">No categories found.</p>
                        </div>
                    </div>
                </div>

                <!-- Order History View -->
                <div id="orderHistoryManagement" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Today's Orders</h3>
                    <button onclick="loadTodaysOrdersForReprint()" class="mb-4 px-4 py-2 btn-secondary text-sm">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh List
                    </button>
                    <div id="todaysOrdersList" class="space-y-2 max-h-[60vh] overflow-y-auto pr-1 border border-gray-200 rounded-md p-2 bg-gray-50">
                        <p class="text-xs text-gray-500 italic">Loading today's orders...</p>
                    </div>
                </div>
                
                <!-- NEW: License Management View -->
                <div id="licenseManagement" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">License Information</h3>
                    <div class="bg-gray-100 p-4 rounded-lg space-y-4">
                        <div>
                            <h4 class="text-lg font-medium text-gray-700">Current Status</h4>
                            <p id="license-status-display" class="text-base font-semibold text-gray-900 mt-1">Loading...</p>
                        </div>
                        <div class="border-t border-gray-300 pt-4">
                            <h4 class="text-lg font-medium text-gray-700">Your Hardware ID</h4>
                            <p class="text-sm text-gray-600 mt-1">To purchase a full license, you must provide the following Hardware ID. This locks the license to this specific computer.</p>
                            <div class="mt-2 bg-white p-3 rounded-md flex items-center justify-between border border-gray-300">
                                <code id="hardware-id-display" class="text-sm font-mono text-gray-800">Loading...</code>
                                <button id="copy-hwid-btn" class="copy-btn" onclick="copyHardwareId()">
                                    <i class="far fa-copy mr-1"></i> Copy
                                </button>
                            </div>
                        </div>
                         <div class="border-t border-gray-300 pt-4">
                            <h4 class="text-lg font-medium text-gray-700">How to Activate</h4>
                             <ol class="list-decimal list-inside text-sm text-gray-600 mt-2 space-y-2">
                                <li>Copy your unique Hardware ID from above.</li>
                                <li>Email the Hardware ID to <a href="mailto:your-email@example.com" class="text-blue-600 hover:underline">your-email@example.com</a> to purchase a license.</li>
                                <li>You will receive a `license.key` file back.</li>
                                <li>Place the `license.key` file in the same folder as the `POSPal.exe` application.</li>
                                <li>Restart the POSPal application to activate the full version.</li>
                            </ol>
                        </div>
                    </div>
                </div>

            </div>
            <!-- Footer: Version and Shutdown -->
            <div id="appVersionContainer" class="p-3 border-t border-gray-200 bg-gray-50 flex justify-between items-center text-xs text-gray-500 flex-shrink-0 rounded-b-lg">
                <div class="flex items-center gap-4">
                    <span>POSPal Version: <span id="appVersion" class="font-medium text-gray-600">...</span></span>
                    <!-- NEW: Trial Status Display in Footer -->
                    <span id="footer-trial-status" class="font-medium"></span>
                </div>
                <button onclick="shutdownApplication()" class="btn-danger text-white py-1 px-3 rounded-md flex items-center text-xs font-semibold">
                    <i class="fas fa-power-off mr-1.5"></i>
                    <span>Shutdown</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemFormModal" class="fixed inset-0 bg-black bg-opacity-70 z-[80] hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-300 flex justify-between items-center">
                <h2 id="itemFormModalTitle" class="text-xl font-semibold">Add/Edit Item</h2>
                <button onclick="closeItemFormModal()" class="text-gray-500 hover:text-black"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto p-4">
                <form id="itemManagementForm" class="space-y-4 management-form">
                    <input type="hidden" id="itemId" name="itemId"> 
                    <div class="grid gap-4 md:grid-cols-2">
                        <div>
                            <label for="itemName" class="block text-sm font-medium text-gray-700">Item Name</label>
                            <input type="text" id="itemName" name="itemName" class="mt-1 block w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm sm:text-sm" required>
                        </div>
                        <div>
                            <label for="itemPrice" class="block text-sm font-medium text-gray-700">Base Price (€)</label>
                            <input type="number" step="0.01" id="itemPrice" name="itemPrice" inputmode="decimal" class="mt-1 block w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm sm:text-sm" required>
                        </div>
                    </div>

                    <div>
                        <label for="itemCategory" class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="itemCategory" name="itemCategory" class="mt-1 block w-full px-3 py-2 border border-gray-400 bg-white rounded-md shadow-sm sm:text-sm" required>
                        </select>
                    </div>

                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="itemHasOptionsModal" name="itemHasOptionsModal" onchange="toggleItemOptionsUIInModal()" class="h-4 w-4 text-black border-gray-400 rounded focus:ring-black accent-black">
                                <label for="itemHasOptionsModal" class="ml-2 block text-sm text-gray-800">Has General Options</label>
                            </div>
                        </div>

                        <div id="itemOptionsModalContainer" class="hidden space-y-3 p-3 border border-gray-300 rounded-md bg-gray-50">
                            <label class="block text-sm font-medium text-gray-700">General Item Options:</label>
                            <div id="itemOptionsListDisplayModal" class="flex flex-wrap gap-2 mb-2 min-h-[40px] border border-gray-200 p-2 rounded-md bg-white">
                                <p class="text-xs text-gray-500 italic w-full">No general options added</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                                <div class="md:col-span-2">
                                    <label for="newOptionNameInputModal" class="block text-xs font-medium text-gray-600">Option Name</label>
                                    <input type="text" id="newOptionNameInputModal" placeholder="e.g., Peppercorn Sauce" class="mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm sm:text-sm">
                                </div>
                                <div>
                                    <label for="newOptionPriceInputModal" class="block text-xs font-medium text-gray-600">Price Change (€)</label>
                                    <input type="number" step="0.01" id="newOptionPriceInputModal" placeholder="e.g., 2.00 or -0.50" inputmode="decimal" class="mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm sm:text-sm">
                                </div>
                            </div>
                            <button type="button" onclick="addOptionToItemFormTempModal()" class="mt-2 px-4 py-2 btn-secondary text-sm w-full md:w-auto">Add Option</button>
                        </div>
                    </div>

                    <div class="flex gap-2 pt-4 border-t border-gray-200">
                        <button type="button" id="saveItemBtn" onclick="saveItem()" class="w-full py-2 px-4 btn-success">Save</button>
                        <button type="button" onclick="closeItemFormModal()" class="w-full py-2 px-4 btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Day Summary Modal -->
    <div id="daySummaryModal" class="fixed inset-0 bg-black bg-opacity-70 z-[80] hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col text-gray-800">
            <div class="p-4 border-b border-gray-300 flex justify-between items-center">
                <h2 class="text-xl font-semibold">Day Summary</h2>
                <button onclick="closeDaySummaryModal()" class="text-gray-500 hover:text-black"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="daySummaryContent" class="p-6 space-y-4">
                <p class="text-center italic">Loading summary...</p>
            </div>
        </div>
    </div>


    <div id="toast" class="fixed top-5 right-5 bg-gray-800 text-white px-4 py-2 rounded-md shadow-lg text-sm z-[100] hidden opacity-0 transition-opacity duration-300">
        <span id="toast-message">Toast message here</span>
    </div>

    <div id="kitchenTicket" class="hidden print-section">
        <h2>Order #<span id="ticket-order-number"></span></h2>
        <div id="ticket-items"></div>
        <div id="ticket-notes">Notes: <span id="ticket-notes-content"></span></div>
        <div id="ticket-time"></div>
    </div>

    <script>
        // --- Global State & Configuration ---
        let menu = {}; 
        let selectedCategory = null; 
        let editingItem = null; 
        let currentOrder = JSON.parse(localStorage.getItem('sushakiSteakhouseCurrentOrder')) || [];
        let currentOrderLineItemCounter = parseInt(localStorage.getItem('sushakiSteakhouseOrderLineItemCounter')) || 0; 
        let orderNumber = 1; 
        let universalOrderComment = localStorage.getItem('sushakiSteakhouseUniversalOrderComment') || "";
        let selectedTableNumber = localStorage.getItem('sushakiSteakhouseSelectedTable') || "";
        let isPaidByCard = false;

        let isMobileOrderPanelOpen = false;
        let itemForNumpad = null; 
        let numpadCurrentInput = "";

        let itemBeingConfigured = null; 
        let currentOptionSelectionStep = null; 

        const SELECTED_TABLE_KEY = 'sushakiSteakhouseSelectedTable';

        const elements = {}; 

        function cacheDOMElements() {
            elements.headerOrderNumber = document.getElementById('header-order-number');
            elements.headerTableInput = document.getElementById('header-table-input');
            elements.headerTableContainer = document.getElementById('header-table-container');
            elements.realtimeClock = document.getElementById('realtime-clock');
            elements.categoriesContainer = document.getElementById('categories');
            elements.productsContainer = document.getElementById('products');
            elements.orderItemsContainer = document.getElementById('order-items-container');
            elements.emptyOrderMessage = document.getElementById('empty-order-message');
            elements.orderTotalDisplay = document.getElementById('order-total');
            elements.universalOrderCommentInput = document.getElementById('universalOrderCommentInput');
            elements.paidByCardCheckbox = document.getElementById('paidByCardCheckbox');
            elements.mobileOrderToggle = document.getElementById('mobile-order-toggle');
            elements.mobileOrderCountBadge = document.getElementById('mobile-order-count-badge');
            elements.orderPanel = document.getElementById('order-panel');
            elements.orderPanelBackdrop = document.getElementById('order-panel-backdrop');
            elements.sendOrderBtn = document.getElementById('sendOrderBtn');
            elements.settingsGearContainer = document.getElementById('settings-gear-container');
            
            // Modals
            elements.loginModal = document.getElementById('loginModal');
            elements.loginForm = document.getElementById('loginForm');
            elements.passwordInput = document.getElementById('passwordInput');
            elements.loginError = document.getElementById('loginError');
            elements.loginSubmitBtn = document.getElementById('loginSubmitBtn');
            
            elements.managementModal = document.getElementById('managementModal');
            elements.itemFormModal = document.getElementById('itemFormModal');
            elements.itemFormModalTitle = document.getElementById('itemFormModalTitle');
            elements.daySummaryModal = document.getElementById('daySummaryModal');
            elements.daySummaryContent = document.getElementById('daySummaryContent');
            elements.itemOptionSelectModal = document.getElementById('itemOptionSelectModal');
            elements.optionModalItemName = document.getElementById('optionModalItemName');
            elements.optionModalItemDescription = document.getElementById('optionModalItemDescription');
            elements.optionModalOptionsContainer = document.getElementById('optionModalOptionsContainer');
            elements.confirmOptionBtn = document.getElementById('confirmOptionBtn');
            elements.itemNameInput = document.getElementById('itemName');
            elements.itemPriceInput = document.getElementById('itemPrice');
            elements.itemCategorySelect = document.getElementById('itemCategory');
            elements.itemIdInput = document.getElementById('itemId'); 
            elements.saveItemBtn = document.getElementById('saveItemBtn');
            elements.existingItemsListModal = document.getElementById('existingItemsListModal');
            elements.itemHasOptionsCheckboxModal = document.getElementById('itemHasOptionsModal'); 
            elements.itemOptionsModalContainer = document.getElementById('itemOptionsModalContainer');
            elements.itemOptionsListDisplayModal = document.getElementById('itemOptionsListDisplayModal');
            elements.newOptionNameInputModal = document.getElementById('newOptionNameInputModal');
            elements.newOptionPriceInputModal = document.getElementById('newOptionPriceInputModal'); 
            elements.categoryNameInput = document.getElementById('categoryName');
            elements.existingCategoriesListModal = document.getElementById('existingCategoriesListModal');
            elements.toast = document.getElementById('toast');
            elements.toastMessage = document.getElementById('toast-message');
            elements.numpadContainer = document.getElementById('numpad-container');
            elements.numpadItemNameDisplay = document.getElementById('numpad-item-name');
            elements.todaysOrdersList = document.getElementById('todaysOrdersList');
            elements.appVersionContainer = document.getElementById('appVersionContainer');
            elements.appVersion = document.getElementById('appVersion');

            // NEW: License and Trial elements
            elements.licenseStatusDisplay = document.getElementById('license-status-display');
            elements.hardwareIdDisplay = document.getElementById('hardware-id-display');
            elements.copyHwidBtn = document.getElementById('copy-hwid-btn');
            elements.footerTrialStatus = document.getElementById('footer-trial-status');
        }

        document.addEventListener('DOMContentLoaded', () => {
            cacheDOMElements();
            initializeAppState();
            loadMenu();
            startClock();
            checkAndDisplayTrialStatus(); // Check trial status on load

            if(elements.universalOrderCommentInput) {
                elements.universalOrderCommentInput.addEventListener('input', (e) => {
                    universalOrderComment = e.target.value;
                    localStorage.setItem('sushakiSteakhouseUniversalOrderComment', universalOrderComment);
                });
            }
            
            if(elements.paidByCardCheckbox) {
                elements.paidByCardCheckbox.addEventListener('change', (e) => {
                    isPaidByCard = e.target.checked;
                });
            }
            
            if(elements.headerTableInput) {
                elements.headerTableInput.addEventListener('change', handleTableNumberChange);
                elements.headerTableInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        handleTableNumberChange(e);
                        e.target.blur(); // Remove focus from input
                    }
                });
            }

            if (elements.loginForm) {
                elements.loginForm.addEventListener('submit', handleLogin);
            }

            updateOrderDisplay();
        });

        function startClock() {
            if (!elements.realtimeClock) return;
            const update = () => {
                // Using en-GB locale is a reliable way to get 24-hour format HH:MM
                elements.realtimeClock.textContent = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            };
            update();
            setInterval(update, 1000 * 60); // Update every minute is enough
        }

        async function fetchAndUpdateOrderNumber() {
            try {
                const response = await fetch('/api/order_status');
                if (!response.ok) {
                    throw new Error(`Server responded with status ${response.status}`);
                }
                const data = await response.json();
                if (data && typeof data.next_order_number !== 'undefined') {
                    orderNumber = data.next_order_number;
                    if(elements.headerOrderNumber) elements.headerOrderNumber.textContent = orderNumber;
                }
            } catch (error) {
                console.error("Could not fetch next order number:", error);
                if(elements.headerOrderNumber) elements.headerOrderNumber.textContent = "Err";
                showToast("Could not sync order number with server.", "error");
            }
        }
        
        function initializeAppState() {
            fetchAndUpdateOrderNumber();
            selectedTableNumber = localStorage.getItem(SELECTED_TABLE_KEY) || "";
            if(elements.headerTableInput) {
                elements.headerTableInput.value = selectedTableNumber;
            }
            if(elements.universalOrderCommentInput) {
                elements.universalOrderCommentInput.value = localStorage.getItem('sushakiSteakhouseUniversalOrderComment') || "";
            }
        }


        async function loadMenu() {
            try {
                const response = await fetch('/api/menu');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                menu = await response.json() || {};

                if (Object.keys(menu).length > 0 && (!selectedCategory || !menu[selectedCategory])) {
                    selectedCategory = Object.keys(menu)[0];
                } else if (Object.keys(menu).length === 0) {
                    selectedCategory = null;
                }
                renderCategories();
                populateManagementCategorySelect();
            } catch (error) {
                showToast(`Error loading menu: ${error.message}`, 'error');
                console.error("Load menu error:", error);
                if(elements.categoriesContainer) elements.categoriesContainer.innerHTML = '<p class="text-gray-500 italic">Could not load categories.</p>';
                if(elements.productsContainer) elements.productsContainer.innerHTML = '<p class="text-gray-500 italic col-span-full text-center">Could not load items.</p>';
            }
        }

        async function saveMenuToServer() {
            try {
                const response = await fetch('/api/menu', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(menu)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({message: `HTTP ${response.status} - ${response.statusText}`}));
                    throw new Error(`Failed to save menu: ${errorData.message}`);
                }
                return true;
            } catch (error) {
                showToast(error.message, 'error');
                console.error("Save menu error:", error);
                return false;
            }
        }

        function renderCategories() {
            if (!elements.categoriesContainer) return;
            elements.categoriesContainer.innerHTML = '';

            if (Object.keys(menu).length === 0) {
                elements.categoriesContainer.innerHTML = '<p class="text-gray-500 italic">No categories defined.</p>';
                if (elements.productsContainer) {
                    elements.productsContainer.innerHTML = '<p class="text-gray-600 italic col-span-full text-center py-8">Please add categories and items in Management.</p>';
                }
                return;
            }

            const selectEl = document.createElement('select');
            selectEl.className = 'w-full p-2.5 border border-gray-400 rounded-md shadow-sm bg-white text-sm';
            selectEl.id = 'categorySelectorDropdown';

            Object.keys(menu).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                if (category === selectedCategory) {
                    option.selected = true;
                }
                selectEl.appendChild(option);
            });

            selectEl.onchange = (event) => {
                selectedCategory = event.target.value;
                renderProductsForSelectedCategory();
            };

            elements.categoriesContainer.appendChild(selectEl);

            if (selectedCategory && Object.keys(menu).includes(selectedCategory)) {
                 renderProductsForSelectedCategory();
            } else if (Object.keys(menu).length > 0 && selectEl.options.length > 0) {
                selectedCategory = selectEl.value;
                renderProductsForSelectedCategory();
            } else {
                 if (elements.productsContainer) elements.productsContainer.innerHTML = '<p class="text-gray-600 italic col-span-full text-center py-8">Select a category.</p>';
            }
        }

        function renderProductsForSelectedCategory() {
            if (!elements.productsContainer) return;
            elements.productsContainer.innerHTML = '';
            if (!selectedCategory || !menu[selectedCategory] || menu[selectedCategory].length === 0) {
                elements.productsContainer.innerHTML = `<p class="text-gray-600 italic col-span-full text-center py-8">No items in "${selectedCategory || 'this'}" category.</p>`;
                return;
            }

            menu[selectedCategory].forEach(item => {
                const card = document.createElement('div');
                card.className = 'product-card bg-white rounded-lg shadow hover:shadow-md transition-shadow overflow-hidden flex flex-col cursor-pointer border border-gray-200';
                card.onclick = () => addToOrder(item.id);

                let badgeIconsHTML = '';
                const hasGenOptions = item.hasGeneralOptions && item.generalOptions && item.generalOptions.length > 0;

                let actualBadgeElements = [];
                if (hasGenOptions) {
                    actualBadgeElements.push(`<span class="options-badge inline-flex items-center justify-center p-1 w-6 h-6 rounded"><i class="fas fa-cogs text-sm"></i></span>`);
                }

                if (actualBadgeElements.length > 0) {
                    badgeIconsHTML = `
                        <div class="absolute bottom-2 right-2 flex flex-col space-y-1">
                            ${actualBadgeElements.join('')}
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="relative p-3 flex-grow flex flex-col h-full">
                        <div class="flex-grow flex flex-col pr-8"> 
                            <div class="flex-grow">
                                <h3 class="text-sm font-semibold text-gray-800 mb-1">${item.name}</h3>
                            </div>
                            <div class="mt-auto">
                               <p class="text-lg font-bold text-black">€${(item.price || 0).toFixed(2)}</p>
                            </div>
                        </div>
                        ${badgeIconsHTML}
                    </div>
                `;
                elements.productsContainer.appendChild(card);
            });
        }
        
        function addToOrder(itemId) {
            let menuItem;
            for (const categoryKey in menu) {
                const found = (menu[categoryKey] || []).find(i => i.id === itemId);
                if (found) { menuItem = found; break; }
            }

            if (!menuItem) {
                console.error("Menu item not found for ID:", itemId);
                showToast("Error: Item not found.", 'error');
                return;
            }

            itemBeingConfigured = {...menuItem}; 
            currentOptionSelectionStep = null; 

            const hasGenOpts = (itemBeingConfigured.hasGeneralOptions && itemBeingConfigured.generalOptions && Array.isArray(itemBeingConfigured.generalOptions) && itemBeingConfigured.generalOptions.length > 0);

            if (hasGenOpts) {
                currentOptionSelectionStep = 'general';
                openItemOptionSelectModal(itemBeingConfigured, 'general_item_option');
            } else {
                finalizeAndAddOrderItem(itemBeingConfigured, []);
                resetMultiStepSelection();
            }
        }

        function finalizeAndAddOrderItem(baseItem, generalChoicesWithOptions) { 
            currentOrderLineItemCounter++;
            localStorage.setItem('sushakiSteakhouseOrderLineItemCounter', currentOrderLineItemCounter.toString());

            let uniqueSuffixParts = [];
            if (generalChoicesWithOptions && generalChoicesWithOptions.length > 0) {
                 uniqueSuffixParts.push(...generalChoicesWithOptions.map(opt => opt.name.replace(/\s+/g, '_')));
            }
            
            const uniqueLineIdSuffix = uniqueSuffixParts.length > 0 ? uniqueSuffixParts.join('-') : 'noopts';
            const uniqueLineId = `${baseItem.id}-${uniqueLineIdSuffix}-line-${currentOrderLineItemCounter}`;

            let itemPriceWithModifiers = parseFloat(baseItem.price || 0);
            if (generalChoicesWithOptions && generalChoicesWithOptions.length > 0) {
                generalChoicesWithOptions.forEach(opt => {
                    itemPriceWithModifiers += parseFloat(opt.priceChange || 0);
                });
            }

            const orderItem = {
                ...baseItem, 
                quantity: 1,
                comment: "",
                orderId: uniqueLineId,
                generalSelectedOptions: generalChoicesWithOptions || [], 
                itemPriceWithModifiers: itemPriceWithModifiers 
            };
            currentOrder.push(orderItem);
            updateOrderDisplay();
        }
        
        function resetMultiStepSelection() {
            itemBeingConfigured = null;
            currentOptionSelectionStep = null;
        }


        function updateOrderDisplay() {
            if (!elements.orderItemsContainer || !elements.emptyOrderMessage) return;
            elements.orderItemsContainer.innerHTML = '';
            let total = 0;

            if (currentOrder.length === 0) {
                elements.emptyOrderMessage.style.display = 'block';
            } else {
                elements.emptyOrderMessage.style.display = 'none';
                currentOrder.forEach(item => {
                    const pricePerUnit = typeof item.itemPriceWithModifiers === 'number' ? item.itemPriceWithModifiers : parseFloat(item.price || 0);
                    const itemTotal = pricePerUnit * item.quantity;
                    total += itemTotal;

                    const div = document.createElement('div');
                    div.className = `order-item p-2 border-b border-gray-200 flex items-center justify-between text-sm ${item.orderId === itemForNumpad?.orderId ? 'selected-for-numpad' : ''}`;

                    let optionDisplayHTML = '';
                    if (item.generalSelectedOptions && item.generalSelectedOptions.length > 0) {
                        item.generalSelectedOptions.forEach(opt => {
                            const priceChangeDisplay = parseFloat(opt.priceChange || 0) !== 0 ? ` (${parseFloat(opt.priceChange || 0) > 0 ? '+' : ''}€${parseFloat(opt.priceChange || 0).toFixed(2)})` : '';
                            optionDisplayHTML += `<span class="block text-xs text-gray-600 ml-4">↳ ${opt.name}${priceChangeDisplay}</span>`;
                        });
                    }
                    let commentText = item.comment ? `<span class="block text-xs text-gray-600 ml-4 break-all"><em>Note: ${item.comment}</em></span>` : '';

                    div.innerHTML = `
                        <div class="flex-grow pr-2">
                            <span class="font-medium text-gray-800">${item.name}</span>
                            <span class="text-xs text-gray-500 ml-1">(Base: €${parseFloat(item.price || 0).toFixed(2)})</span>
                            ${optionDisplayHTML}
                            ${commentText}
                        </div>
                        <div class="flex flex-col items-end space-y-1 flex-shrink-0">
                             <span class="font-semibold text-gray-800">€${pricePerUnit.toFixed(2)} x ${item.quantity} = €${itemTotal.toFixed(2)}</span>
                            <div class="flex items-center space-x-1">
                                <button onclick="decrementQuantity('${item.orderId}')" class="p-1 text-gray-500 hover:text-red-600"><i class="fas fa-minus-circle"></i></button>
                                <span class="font-semibold text-gray-800 w-6 text-center cursor-pointer" onclick="openNumpadForOrderItem('${item.orderId}', ${item.quantity}, '${item.name.replace(/'/g, "\\'")}')">${item.quantity}</span>
                                <button onclick="incrementQuantity('${item.orderId}')" class="p-1 text-gray-500 hover:text-green-600"><i class="fas fa-plus-circle"></i></button>
                                <button onclick="promptForItemComment('${item.orderId}')" class="p-1 text-gray-500 hover:text-black" title="Add Note"><i class="fas fa-comment-dots"></i></button>
                                <button onclick="removeItemByOrderId('${item.orderId}')" class="p-1 text-red-500 hover:text-red-700" title="Remove Item"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                    `;
                    elements.orderItemsContainer.appendChild(div);
                });
            }

            if(elements.orderTotalDisplay) elements.orderTotalDisplay.textContent = `€${total.toFixed(2)}`;
            localStorage.setItem('sushakiSteakhouseCurrentOrder', JSON.stringify(currentOrder));
            updateMobileOrderBadge();
        }

        function incrementQuantity(orderId) {
            const item = currentOrder.find(i => i.orderId === orderId);
            if (item) { item.quantity++; updateOrderDisplay(); }
        }

        function decrementQuantity(orderId) {
            const item = currentOrder.find(i => i.orderId === orderId);
            if (item) {
                item.quantity--;
                if (item.quantity <= 0) removeItemByOrderId(orderId);
                else updateOrderDisplay();
            }
        }

        function removeItemByOrderId(orderId) {
            currentOrder = currentOrder.filter(item => item.orderId !== orderId);
            if (itemForNumpad && itemForNumpad.orderId === orderId) hideNumpad();
            updateOrderDisplay();
            showToast('Item removed from order.', 'info');
        }

        function promptForItemComment(orderId) {
            const item = currentOrder.find(i => String(i.orderId) === orderId);
            if (item) {
                let currentSelectionDisplay = "";
                if (item.generalSelectedOptions && item.generalSelectedOptions.length > 0) {
                     currentSelectionDisplay += ` (Opt: ${item.generalSelectedOptions.map(opt => opt.name + (parseFloat(opt.priceChange || 0) !== 0 ? ` ${parseFloat(opt.priceChange || 0) > 0 ? '+' : ''}€${parseFloat(opt.priceChange || 0).toFixed(2)}` : '')).join(', ')})`;
                }
                const newComment = prompt("Enter note for " + item.name + currentSelectionDisplay.trim() + ":", item.comment || "");
                if (newComment !== null) {
                    item.comment = newComment.trim();
                    updateOrderDisplay();
                }
            }
        }

        function clearOrderData() {
            currentOrder = [];
            universalOrderComment = "";
            if(elements.universalOrderCommentInput) elements.universalOrderCommentInput.value = "";
            localStorage.removeItem('sushakiSteakhouseUniversalOrderComment');
            currentOrderLineItemCounter = 0;
            localStorage.setItem('sushakiSteakhouseOrderLineItemCounter', '0');
            isPaidByCard = false;
            if(elements.paidByCardCheckbox) elements.paidByCardCheckbox.checked = false;

            hideNumpad();
            updateOrderDisplay();
            fetchAndUpdateOrderNumber();
        }
        
        function newOrder() {
            if (currentOrder.length > 0 && !confirm("Clear current order and start a new one? This will clear all items and notes.")) {
                return;
            }
            
            clearOrderData();
            showToast('Order cleared. Ready for the next order.', 'info');
        }

    async function sendOrder() {
        if (!elements.sendOrderBtn) return;

        if (!currentOrder.length) {
            showToast('Order is empty!', 'warning');
            return;
        }
        if (!selectedTableNumber || selectedTableNumber.trim() === "") {
            showToast('Please select a table.', 'warning');
            if (elements.headerTableContainer) {
                elements.headerTableContainer.classList.add('ring-2', 'ring-red-500');
                setTimeout(() => {
                     elements.headerTableContainer.classList.remove('ring-2', 'ring-red-500');
                }, 2000);
            }
            return;
        }

        elements.sendOrderBtn.disabled = true;
        elements.sendOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Sending...';

        const orderData = {
            tableNumber: selectedTableNumber,
            items: currentOrder.map(item => ({
                id: item.id,
                name: item.name,
                basePrice: parseFloat(item.price || 0), 
                quantity: item.quantity,
                generalSelectedOptions: item.generalSelectedOptions || [], 
                itemPriceWithModifiers: item.itemPriceWithModifiers, 
                comment: item.comment || "",
            })),
            universalComment: universalOrderComment.trim(),
            paymentMethod: isPaidByCard ? 'Card' : 'Cash'
        };

        try {
            const response = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            // Try to parse JSON body regardless of status code
            const result = await response.json().catch(() => ({}));

            if (response.ok) {
                if (result.status === "success") {
                    showToast(result.message || `Order #${result.order_number} sent, all copies printed, and logged!`, 'success');
                } else if (result.status === "warning_print_copy2_failed") {
                    showToast(result.message || `Order #${result.order_number}: Copy 1 PRINTED & LOGGED. Copy 2 FAILED.`, 'warning', 7000);
                } else if (result.status === "error_print_failed_copy1") {
                    showToast(result.message || `Order #${result.order_number} - COPY 1 FAILED. Order NOT saved.`, 'error', 7000);
                } else if (result.status === "error_log_failed_after_print") {
                    showToast(result.message || `Order #${result.order_number} - PRINTED but LOGGING FAILED. Notify staff!`, 'error', 10000);
                } else {
                    showToast(result.message || `Order #${result.order_number} processed with issues: ${result.status}`, 'warning', 7000);
                }

                if (result.status === "success" || result.status === "warning_print_copy2_failed" || result.status === "error_log_failed_after_print") {
                    clearOrderData();
                }

            } else {
                // Handle non-ok responses (like 403 for expired trial)
                if (response.status === 403 && result.status === 'error_trial_expired') {
                    showToast(result.message, 'error', 10000);
                    // Automatically open the management modal to the license tab for user convenience
                    openManagementModal();
                    const licenseTabButton = document.querySelector('.management-tab[onclick*="\'license\'"]');
                    if (licenseTabButton) {
                        switchManagementTab('license', licenseTabButton);
                    }
                } else {
                    const errorMsg = result.message || `Server error: ${response.status}. Please check server logs.`;
                    showToast(errorMsg, 'error', 7000);
                }
                fetchAndUpdateOrderNumber();
            }
        } catch (error) {
            console.error('Send order network/parse error:', error);
            let detailedErrorMsg = 'Network error or invalid server response. Could not send order.';
            if (error instanceof TypeError) {
                 detailedErrorMsg = 'Server returned an unexpected response format. Check server logs.';
            } else if (error.message) {
                detailedErrorMsg = `Error: ${error.message}. Could not send order.`;
            }
            showToast(detailedErrorMsg + ' Order remains on screen.', 'error', 7000);
            fetchAndUpdateOrderNumber();
        } finally {
            if(elements.sendOrderBtn) {
                elements.sendOrderBtn.disabled = false;
                elements.sendOrderBtn.innerHTML = '<i class="fas fa-paper-plane mr-1"></i> Send Order';
            }
        }
    }

        function toggleMobileOrderPanel() {
            isMobileOrderPanelOpen = !isMobileOrderPanelOpen;
            if (isMobileOrderPanelOpen) {
                elements.orderPanel.classList.remove('translate-y-full');
                elements.orderPanelBackdrop.classList.remove('hidden');
                if (elements.settingsGearContainer) elements.settingsGearContainer.classList.add('hidden');
                document.body.style.overflow = 'hidden';
            } else {
                elements.orderPanel.classList.add('translate-y-full');
                elements.orderPanelBackdrop.classList.add('hidden');
                if (elements.settingsGearContainer) elements.settingsGearContainer.classList.remove('hidden');
                document.body.style.overflow = '';
                hideNumpad();
            }
        }

        function updateMobileOrderBadge() {
            const count = currentOrder.reduce((sum, item) => sum + item.quantity, 0);
            if (elements.mobileOrderCountBadge) {
                if (count > 0) {
                    elements.mobileOrderCountBadge.textContent = count;
                    elements.mobileOrderCountBadge.classList.remove('hidden');
                } else {
                    elements.mobileOrderCountBadge.classList.add('hidden');
                }
            }
        }

        function openNumpadForOrderItem(orderId, currentQuantity, itemName) {
            itemForNumpad = { orderId, currentQuantity, itemName };
            numpadCurrentInput = currentQuantity.toString();
            if (elements.numpadItemNameDisplay) elements.numpadItemNameDisplay.innerHTML = `Quantity for: <span class="font-bold">${itemName}</span>`;
            if (elements.numpadContainer) elements.numpadContainer.classList.remove('hidden');
            updateOrderDisplay();
        }

        function hideNumpad() {
            if (elements.numpadContainer) elements.numpadContainer.classList.add('hidden');
            itemForNumpad = null;
            numpadCurrentInput = "";
            updateOrderDisplay();
        }

        function handleNumpadInput(value) {
            if (!itemForNumpad) return;
            if (value === 'clear') {
                numpadCurrentInput = "";
            } else if (value === 'backspace') {
                numpadCurrentInput = numpadCurrentInput.slice(0, -1);
            } else if (numpadCurrentInput.length < 3) {
                numpadCurrentInput += value;
            }
        }

        function confirmNumpadInput() {
            if (!itemForNumpad) return;
            const newQuantity = parseInt(numpadCurrentInput);
            const item = currentOrder.find(i => i.orderId === itemForNumpad.orderId);

            if (item) {
                if (!isNaN(newQuantity) && newQuantity > 0) {
                    item.quantity = newQuantity;
                } else if (numpadCurrentInput === "" || newQuantity === 0) {
                    removeItemByOrderId(item.orderId);
                } else {
                    showToast("Invalid quantity. Please enter a number greater than 0.", "warning");
                }
            }
            hideNumpad();
        }

        // --- Seat/Table Selection Logic ---
        function handleTableNumberChange(event) {
            const newTableNumber = event.target.value.trim();
            if (selectedTableNumber !== newTableNumber) {
                selectedTableNumber = newTableNumber;
                localStorage.setItem(SELECTED_TABLE_KEY, selectedTableNumber);
            }
        }


        // --- Item Option Modal Logic ---
        let currentItemOptionContext = null; 

        function openItemOptionSelectModal(itemForModal, context) { 
            document.querySelectorAll('#optionModalOptionsContainer input').forEach(input => {
                input.checked = false;
                const parentDiv = input.closest('.option-selectable');
                if (parentDiv) parentDiv.classList.remove('selected', 'ring-2', 'border-black', 'bg-gray-100');
            });
            currentItemOptionContext = context; 
            if (!elements.itemOptionSelectModal || !elements.optionModalItemName || !elements.optionModalOptionsContainer) return;

            elements.optionModalItemName.textContent = `Options for: ${itemForModal.name}`;
            elements.optionModalOptionsContainer.innerHTML = '';
            elements.confirmOptionBtn.disabled = true;

            let optionsToShow = [];
            let description = "";
            let inputType = 'radio';

            if (context === 'general_item_option') {
                optionsToShow = itemForModal.generalOptions || [];
                description = `Select option(s) for ${itemForModal.name}. (Multiple selections allowed)`;
                inputType = 'checkbox';
            } else {
                console.warn("Modal opened with unexpected context or item structure:", itemForModal, context);
                elements.optionModalOptionsContainer.innerHTML = `<p class="text-sm text-gray-500">No suitable options for this step.</p>`;
                elements.itemOptionSelectModal.classList.remove('hidden');
                elements.itemOptionSelectModal.classList.add('flex');
                return;
            }
            elements.optionModalItemDescription.textContent = description;

            if (optionsToShow.length > 0) {
                elements.confirmOptionBtn.disabled = false;
                optionsToShow.forEach((optionData, index) => { 
                    const optionName = (typeof optionData === 'object' && optionData.name) ? optionData.name : optionData;
                    const priceChange = (typeof optionData === 'object' && typeof optionData.priceChange === 'number') ? optionData.priceChange : 0;

                    const optionId = `modal_item_opt_${itemForModal.id}_${context}_${optionName.replace(/\s+/g, '_')}_${index}`;
                    const div = document.createElement('div');
                    div.className = "option-selectable p-3 border border-gray-300 rounded-md hover:bg-gray-100 cursor-pointer group focus-within:ring-2";

                    const inputElement = document.createElement('input');
                    inputElement.type = inputType;
                    inputElement.name = `item_option_for_${itemForModal.id}_${context}`; 
                    if (inputType === 'checkbox') {
                        inputElement.name = optionId; 
                    }
                    inputElement.id = optionId;
                    inputElement.value = optionName; 
                    inputElement.dataset.priceChange = priceChange; 
                    inputElement.className = `form-${inputType} h-4 w-4 text-black border-gray-300 focus:ring-black accent-black`;

                    let labelText = optionName;
                    if (inputType === 'checkbox' && priceChange !== 0) {
                        labelText += ` (${priceChange > 0 ? '+' : ''}€${priceChange.toFixed(2)})`;
                    }

                    const label = document.createElement('label');
                    label.htmlFor = optionId;
                    label.textContent = labelText;
                    label.className = "ml-2 text-sm text-gray-700 cursor-pointer flex-grow";
                    
                    const innerFlex = document.createElement('div');
                    innerFlex.className = "flex items-center w-full";
                    innerFlex.appendChild(inputElement);
                    innerFlex.appendChild(label);
                    div.appendChild(innerFlex);
                    
                    div.onclick = function(event) {
                        if (event.target === inputElement || event.target === label || label.contains(event.target)) {
                           return; 
                        }
                        inputElement.click(); 
                    };

                    inputElement.addEventListener('change', function() {
                        const parentDiv = this.closest('.option-selectable');
                        if (!parentDiv) return;

                        if (this.type === 'radio') {
                            if (this.checked) {
                                elements.optionModalOptionsContainer.querySelectorAll('input[type="radio"][name="' + this.name + '"]').forEach(otherRadio => {
                                    const otherParentDiv = otherRadio.closest('.option-selectable');
                                    if (otherParentDiv && otherRadio !== this) {
                                        otherParentDiv.classList.remove('selected', 'border-black', 'bg-gray-100');
                                    }
                                });
                                parentDiv.classList.add('selected', 'border-black', 'bg-gray-100');
                            }
                        } else { 
                            if (this.checked) {
                                parentDiv.classList.add('selected', 'border-black', 'bg-gray-100');
                            } else {
                                parentDiv.classList.remove('selected', 'border-black', 'bg-gray-100');
                            }
                        }
                    });
                    
                    if (inputType === 'radio' && index === 0) { 
                        inputElement.checked = true;
                         setTimeout(() => { 
                            const parentDiv = inputElement.closest('.option-selectable');
                            if(parentDiv && inputElement.checked) { 
                                parentDiv.classList.add('selected', 'border-black', 'bg-gray-100');
                            }
                        }, 0);
                    }
                    elements.optionModalOptionsContainer.appendChild(div);
                });
            } else {
                elements.optionModalOptionsContainer.innerHTML = `<p class="text-sm text-gray-500">No specific options defined for this item.</p>`;
            }
            elements.itemOptionSelectModal.classList.remove('hidden');
            elements.itemOptionSelectModal.classList.add('flex');
        }

        function cancelOptionSelection() {
            if(elements.itemOptionSelectModal) {
                elements.itemOptionSelectModal.classList.add('hidden');
                elements.itemOptionSelectModal.classList.remove('flex');
            }
            currentItemOptionContext = null;
            resetMultiStepSelection(); 
        }

        function confirmOptionSelection() {
            if (!itemBeingConfigured || !elements.optionModalOptionsContainer || !currentItemOptionContext) {
                 console.error("State missing for confirmOptionSelection", itemBeingConfigured, currentItemOptionContext);
                 return;
            }

            if (currentItemOptionContext === 'general_item_option') {
                const checkedBoxes = elements.optionModalOptionsContainer.querySelectorAll('input[type="checkbox"]:checked');
                const generalSelectionsWithOptions = Array.from(checkedBoxes).map(cb => {
                    return {
                        name: cb.value,
                        priceChange: parseFloat(cb.dataset.priceChange || 0)
                    };
                });
                
                finalizeAndAddOrderItem(itemBeingConfigured, generalSelectionsWithOptions);
                resetMultiStepSelection();
                cancelOptionSelection(); 
            }
        }

        // --- Management Modal, Login & Data Logic ---
        let currentManagementTab = 'analytics'; // Default to analytics
        let tempItemOptionsModal = []; 

        function openLoginModal() {
            if (!elements.loginModal) return;
            elements.passwordInput.value = '';
            elements.loginError.classList.add('hidden');
            elements.loginModal.classList.remove('hidden');
            elements.loginModal.classList.add('flex');
            elements.passwordInput.focus();
        }

        function closeLoginModal() {
            if (!elements.loginModal) return;
            elements.loginModal.classList.add('hidden');
            elements.loginModal.classList.remove('flex');
        }

        async function handleLogin(event) {
            event.preventDefault();
            if (!elements.passwordInput || !elements.loginSubmitBtn || !elements.loginError) return;

            const password = elements.passwordInput.value;
            elements.loginSubmitBtn.disabled = true;
            elements.loginSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            elements.loginError.classList.add('hidden');

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    closeLoginModal();
                    openManagementModal();
                } else {
                    elements.loginError.textContent = result.message || 'Login failed. Please try again.';
                    elements.loginError.classList.remove('hidden');
                    elements.passwordInput.select();
                }
            } catch (error) {
                console.error('Login error:', error);
                elements.loginError.textContent = 'A network error occurred. Please try again.';
                elements.loginError.classList.remove('hidden');
            } finally {
                elements.loginSubmitBtn.disabled = false;
                elements.loginSubmitBtn.textContent = 'Login';
            }
        }

        async function loadAppVersion() {
            if (!elements.appVersion) return;
            try {
                const response = await fetch('/api/version');
                if (!response.ok) throw new Error('Failed to fetch version');
                const data = await response.json();
                elements.appVersion.textContent = data.version;
            } catch (error) {
                console.error("Error fetching app version:", error);
                elements.appVersion.textContent = 'N/A';
            }
        }

        function openManagementModal() {
            if (!elements.managementModal) return;
            elements.managementModal.classList.remove('hidden');
            elements.managementModal.classList.add('flex');
            document.body.style.overflow = 'hidden'; // Prevent body scrolling
            loadManagementData();
            loadAppVersion();
            checkAndDisplayTrialStatus(); // Refresh trial status when opening
            // Reset to the main tab when opening
            const analyticsTabButton = document.querySelector('.management-tab[onclick*="\'analytics\'"]');
            if (analyticsTabButton) {
                switchManagementTab('analytics', analyticsTabButton); 
            }
        }

        function closeManagementModal() {
            if (!elements.managementModal) return;
            elements.managementModal.classList.add('hidden');
            elements.managementModal.classList.remove('flex');
            document.body.style.overflow = ''; // Allow scrolling on the body again
        }


        function switchManagementTab(tabName, clickedButton) {
            currentManagementTab = tabName;
            document.querySelectorAll('.management-tab').forEach(btn => {
                btn.classList.remove('bg-white', 'shadow-sm', 'text-gray-800');
                btn.classList.add('text-gray-600', 'hover:bg-gray-200');
            });
            if (clickedButton) {
                clickedButton.classList.add('bg-white', 'shadow-sm', 'text-gray-800');
                clickedButton.classList.remove('text-gray-600', 'hover:bg-gray-200');
            }

            const views = ['analyticsManagement', 'itemsManagement', 'categoriesManagement', 'orderHistoryManagement', 'licenseManagement'];
            views.forEach(id => {
                const view = document.getElementById(id);
                if(view) view.style.display = 'none';
            });

            const activeView = document.getElementById(`${tabName}Management`);
            if(activeView) activeView.style.display = 'block';

            // Special actions for certain tabs
            if (tabName === 'analytics') {
                const todayButton = document.querySelector('.date-range-btn[onclick*="\'today\'"]');
                loadAnalyticsData('today', todayButton);
            } else if (tabName === 'categories') {
                if (elements.categoryNameInput) elements.categoryNameInput.value = '';
            } else if (tabName === 'orderHistory') {
                loadTodaysOrdersForReprint();
            } else if (tabName === 'license') {
                loadHardwareId();
            }
        }

        function populateManagementCategorySelect() {
            if (!elements.itemCategorySelect) return;
            const currentCategoryValue = elements.itemCategorySelect.value;
            elements.itemCategorySelect.innerHTML = Object.keys(menu)
                .map(c => `<option value="${c}">${c}</option>`)
                .join('');
            if (Object.keys(menu).length === 0) {
                elements.itemCategorySelect.innerHTML = '<option value="">Create a category first</option>';
            } else if (currentCategoryValue && menu[currentCategoryValue]) {
                elements.itemCategorySelect.value = currentCategoryValue;
            } else if (elements.itemCategorySelect.options.length > 0) {
                 elements.itemCategorySelect.selectedIndex = 0;
            }
        }

        function loadManagementData() {
            populateManagementCategorySelect();
            renderExistingItemsInModal();
            renderExistingCategoriesInModal();
        }

        function renderExistingItemsInModal() {
            if (!elements.existingItemsListModal) return;
            elements.existingItemsListModal.innerHTML = '';
            let itemCount = 0;

            Object.entries(menu).forEach(([category, items]) => {
                if (!items || items.length === 0) return;

                const categoryHeader = document.createElement('h5');
                categoryHeader.className = "font-bold text-gray-700 mt-3 mb-1 pb-1 border-b border-gray-300";
                categoryHeader.textContent = category;
                elements.existingItemsListModal.appendChild(categoryHeader);

                (items || []).forEach((item, index) => {
                    itemCount++;
                    const div = document.createElement('div');
                    div.className = `p-2 border border-gray-300 rounded-md flex justify-between items-center text-sm bg-white hover:bg-gray-50`;

                    let itemDetails = `<span class="font-medium text-gray-800">${item.name}</span>
                                       <span class="text-xs text-gray-500 ml-1">- €${(item.price || 0).toFixed(2)}</span>`;

                    const hasGeneralOpts = item.hasGeneralOptions && item.generalOptions && item.generalOptions.length > 0;
                    if (hasGeneralOpts) { 
                        itemDetails += `<span class="text-xs text-blue-600 ml-2">(+ Options)</span>`;
                    }

                    const isFirst = index === 0;
                    const isLast = index === items.length - 1;
                    const reorderButtons = `
                        <div class="flex items-center">
                            <button onclick="moveItemPosition(${item.id}, 'up')" class="px-2 py-1 text-gray-500 hover:text-black ${isFirst ? 'opacity-25 cursor-not-allowed' : ''}" ${isFirst ? 'disabled' : ''} title="Move Up">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button onclick="moveItemPosition(${item.id}, 'down')" class="px-2 py-1 text-gray-500 hover:text-black ${isLast ? 'opacity-25 cursor-not-allowed' : ''}" ${isLast ? 'disabled' : ''} title="Move Down">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                        </div>
                    `;

                    div.innerHTML = `
                        <div class="flex items-center">
                            ${reorderButtons}
                            <div class="ml-2">${itemDetails}</div>
                        </div>
                        <div class="space-x-1 flex-shrink-0">
                            <button onclick="openItemFormModal(${item.id})" class="px-2 py-1 text-xs btn-warning text-white rounded hover:opacity-80">Edit</button>
                            <button onclick="deleteItem(${item.id})" class="px-2 py-1 text-xs btn-danger text-white rounded hover:opacity-80">Delete</button>
                        </div>
                    `;
                    elements.existingItemsListModal.appendChild(div);
                });
            });
            if (itemCount === 0) {
                 elements.existingItemsListModal.innerHTML = '<p class="text-xs text-gray-500 italic">No items created yet.</p>';
            }
        }

        async function moveItemPosition(itemIdToMove, direction) {
            let categoryKey = null;
            let itemIndex = -1;

            for (const cat in menu) {
                const index = (menu[cat] || []).findIndex(i => i.id === itemIdToMove);
                if (index !== -1) {
                    categoryKey = cat;
                    itemIndex = index;
                    break;
                }
            }

            if (categoryKey === null || itemIndex === -1) {
                showToast("Could not find item to move.", "error");
                return;
            }

            const itemsArray = menu[categoryKey];
            const itemToMove = itemsArray[itemIndex];

            if (direction === 'up' && itemIndex > 0) {
                itemsArray.splice(itemIndex, 1);
                itemsArray.splice(itemIndex - 1, 0, itemToMove);
            } else if (direction === 'down' && itemIndex < itemsArray.length - 1) {
                itemsArray.splice(itemIndex, 1);
                itemsArray.splice(itemIndex + 1, 0, itemToMove);
            } else {
                return;
            }

            const success = await saveMenuToServer();
            if (success) {
                showToast('Item order updated.', 'success');
                await loadMenu();
                loadManagementData();
            } else {
                showToast('Failed to save new item order. Reverting.', 'error');
                await loadMenu();
                loadManagementData();
            }
        }

        function renderExistingCategoriesInModal() {
            if (!elements.existingCategoriesListModal) return;
            elements.existingCategoriesListModal.innerHTML = '';
            const categoryKeys = Object.keys(menu);

            if (categoryKeys.length === 0) {
                elements.existingCategoriesListModal.innerHTML = '<p class="text-xs text-gray-500 italic">No categories created yet.</p>';
                return;
            }

            categoryKeys.forEach((categoryName, index) => {
                const isFirst = index === 0;
                const isLast = index === categoryKeys.length - 1;

                const reorderButtons = `
                    <div class="flex items-center">
                        <button onclick="moveCategoryPosition('${categoryName}', 'up')" class="px-2 py-1 text-gray-500 hover:text-black ${isFirst ? 'opacity-25 cursor-not-allowed' : ''}" ${isFirst ? 'disabled' : ''} title="Move Up">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button onclick="moveCategoryPosition('${categoryName}', 'down')" class="px-2 py-1 text-gray-500 hover:text-black ${isLast ? 'opacity-25 cursor-not-allowed' : ''}" ${isLast ? 'disabled' : ''} title="Move Down">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </div>
                `;

                const div = document.createElement('div');
                div.className = "p-2 border border-gray-300 rounded-md flex justify-between items-center text-sm bg-white hover:bg-gray-50";
                div.innerHTML = `
                    <div class="flex items-center">
                        ${reorderButtons}
                        <span class="font-medium text-gray-800 ml-2">${categoryName}</span>
                    </div>
                    <button onclick="deleteCategory('${categoryName}')" class="px-2 py-1 text-xs btn-danger text-white rounded hover:opacity-80">Delete</button>
                `;
                elements.existingCategoriesListModal.appendChild(div);
            });
        }
        
        async function moveCategoryPosition(categoryNameToMove, direction) {
            const keys = Object.keys(menu);
            const index = keys.indexOf(categoryNameToMove);

            if (index === -1) {
                showToast("Could not find category to move.", "error");
                return;
            }

            let newIndex;
            if (direction === 'up') {
                if (index === 0) return;
                newIndex = index - 1;
            } else {
                if (index === keys.length - 1) return;
                newIndex = index + 1;
            }

            [keys[index], keys[newIndex]] = [keys[newIndex], keys[index]];

            const newMenu = {};
            keys.forEach(key => {
                newMenu[key] = menu[key];
            });
            menu = newMenu;

            const success = await saveMenuToServer();
            if (success) {
                showToast('Category order updated.', 'success');
                await loadMenu();
                loadManagementData();
            } else {
                showToast('Failed to save new category order. Reverting.', 'error');
                await loadMenu();
                loadManagementData();
            }
        }


        function generateItemId() {
            const allItems = [].concat(...Object.values(menu).map(categoryItems => categoryItems || []));
            return allItems.length > 0 ? Math.max(0, ...allItems.map(i => i.id || 0)) + 1 : 1;
        }

        function resetItemForm() {
            editingItem = null;
            if(elements.itemNameInput) elements.itemNameInput.value = '';
            if(elements.itemPriceInput) elements.itemPriceInput.value = '';
            if(elements.itemIdInput) elements.itemIdInput.value = ''; 
            if(elements.itemCategorySelect && elements.itemCategorySelect.options.length > 0) elements.itemCategorySelect.selectedIndex = 0;
            
            if(elements.itemHasOptionsCheckboxModal) elements.itemHasOptionsCheckboxModal.checked = false;
            tempItemOptionsModal = []; 

            if (elements.newOptionNameInputModal) elements.newOptionNameInputModal.value = '';
            if (elements.newOptionPriceInputModal) elements.newOptionPriceInputModal.value = '';

            toggleItemOptionsUIInModal(); 
        }

        function openItemFormModal(itemIdToEdit = null) {
            resetItemForm();
            if (itemIdToEdit !== null) {
                elements.itemFormModalTitle.textContent = 'Edit Item';
                populateItemFormForEdit(itemIdToEdit);
            } else {
                elements.itemFormModalTitle.textContent = 'Add New Item';
                if(elements.saveItemBtn) elements.saveItemBtn.innerHTML = '💾 Save New Item';
            }
            elements.itemFormModal.classList.remove('hidden');
            elements.itemFormModal.classList.add('flex');
        }

        function closeItemFormModal() {
            elements.itemFormModal.classList.add('hidden');
            elements.itemFormModal.classList.remove('flex');
            resetItemForm();
        }

        function populateItemFormForEdit(itemIdToEdit) {
            let foundItem;
            let itemCategoryName;
            Object.entries(menu).forEach(([category, items]) => {
                const item = (items || []).find(i => i.id === itemIdToEdit);
                if (item) { foundItem = item; itemCategoryName = category; }
            });

            if (foundItem) {
                editingItem = { ...foundItem };
                if(elements.itemNameInput) elements.itemNameInput.value = foundItem.name;
                if(elements.itemPriceInput) elements.itemPriceInput.value = foundItem.price;
                if(elements.itemCategorySelect) elements.itemCategorySelect.value = itemCategoryName;
                if(elements.itemIdInput) elements.itemIdInput.value = foundItem.id; 

                if (foundItem.hasGeneralOptions && foundItem.generalOptions && Array.isArray(foundItem.generalOptions)) {
                    tempItemOptionsModal = [...foundItem.generalOptions];
                } else {
                    tempItemOptionsModal = [];
                }
                if(elements.itemHasOptionsCheckboxModal) {
                     elements.itemHasOptionsCheckboxModal.checked = (foundItem.hasGeneralOptions && tempItemOptionsModal.length > 0);
                }
                toggleItemOptionsUIInModal(); 
                if(elements.saveItemBtn) elements.saveItemBtn.innerHTML = '🔄 Update Item';
            }
        }

        async function saveItem() {
            if (!elements.itemNameInput || !elements.itemPriceInput || !elements.itemCategorySelect) return;

            const itemName = elements.itemNameInput.value.trim();
            const itemPrice = parseFloat(elements.itemPriceInput.value); 
            const itemCategory = elements.itemCategorySelect.value;
            
            let itemIdVal = editingItem ? editingItem.id : generateItemId();
            
            if (isNaN(itemIdVal)) {
                showToast('Error: Invalid Item ID.', 'error'); return;
            }
            if (!itemName || isNaN(itemPrice) || itemPrice < 0) {
                showToast('Item Name and a valid Base Price are required.', 'warning'); return;
            }
            if (!itemCategory && Object.keys(menu).length > 0) {
                showToast('Please select a category.', 'warning'); return;
            }
            if (Object.keys(menu).length === 0 && !itemCategory) {
                showToast('Please create a category first.', 'warning'); return;
            }

            const itemData = {
                id: itemIdVal,
                name: itemName,
                price: itemPrice, 
                hasGeneralOptions: elements.itemHasOptionsCheckboxModal.checked,
                generalOptions: (elements.itemHasOptionsCheckboxModal.checked && tempItemOptionsModal.length > 0) ? [...tempItemOptionsModal] : []
            };

            if (itemData.hasGeneralOptions && itemData.generalOptions.length === 0) {
                showToast('If "Has General Options" is checked, please add at least one option.', 'warning'); return;
            }
            
            if (editingItem) { 
                Object.keys(menu).forEach(cat => {
                    const itemIndex = (menu[cat] || []).findIndex(i => i.id === editingItem.id);
                    if (itemIndex > -1) {
                       if (cat !== itemCategory) { 
                           menu[cat].splice(itemIndex, 1); 
                       }
                    }
                });
            }

            if (!menu[itemCategory]) menu[itemCategory] = [];

            const existingItemIndex = menu[itemCategory].findIndex(i => i.id === itemData.id);
            if (existingItemIndex > -1) {
                menu[itemCategory][existingItemIndex] = itemData; 
            } else { 
                menu[itemCategory].push(itemData);
            }

            const success = await saveMenuToServer();
            if (success) {
                showToast(editingItem ? 'Item updated successfully!' : 'Item saved successfully!', 'success');
                closeItemFormModal();
                await loadMenu();
                loadManagementData();
            } else {
                showToast('Failed to save item to server. Reverting.', 'error');
                await loadMenu();
            }
        }

        async function deleteItem(itemIdToDelete) {
            if (!confirm('Are you sure you want to delete this item? This cannot be undone.')) return;

            let itemFoundAndDeletedLocally = false;
            Object.keys(menu).forEach(cat => {
                const itemIndex = (menu[cat] || []).findIndex(i => i.id === itemIdToDelete);
                if (itemIndex > -1) {
                    menu[cat].splice(itemIndex, 1);
                    itemFoundAndDeletedLocally = true;
                }
            });

            if (!itemFoundAndDeletedLocally) {
                showToast('Item not found for deletion.', 'warning'); return;
            }

            const success = await saveMenuToServer();
            if (success) {
                showToast('Item deleted successfully.', 'success');
                await loadMenu();
                loadManagementData();
            } else {
                showToast('Failed to delete item on server. Reverting.', 'error');
                await loadMenu();
            }
        }

        async function saveCategory() {
			if (!elements.categoryNameInput) return;
			const categoryName = elements.categoryNameInput.value.trim();
			if (!categoryName) { 
				showToast('Category name cannot be empty.', 'warning'); 
				return; 
			}
			if (menu[categoryName]) { 
				showToast('Category already exists.', 'warning'); 
				return; 
			}

			const newMenu = {...menu};
			newMenu[categoryName] = [];
			
			try {
				const response = await fetch('/api/menu', {
					method: 'POST',
					headers: {'Content-Type': 'application/json'},
					body: JSON.stringify(newMenu)
				});
				
				const contentType = response.headers.get('content-type');
				if (!contentType || !contentType.includes('application/json')) {
					const text = await response.text();
					throw new Error(`Invalid response: ${text.substring(0, 100)}`);
				}
				
				if (!response.ok) {
					const errorData = await response.json();
					throw new Error(errorData.message || 'Failed to save category');
				}
				
				menu = newMenu;
				showToast(`Category "${categoryName}" added successfully.`, 'success');
				elements.categoryNameInput.value = '';
				await loadMenu();
                loadManagementData();
				
			} catch (error) {
				showToast(`Failed to save category: ${error.message}`, 'error');
			}
			
		}

        async function deleteCategory(categoryNameToDelete) {
            if (menu[categoryNameToDelete] && menu[categoryNameToDelete].length > 0) {
                if (!confirm(`Category "${categoryNameToDelete}" contains items. Are you sure you want to delete the category AND ALL ITS ITEMS? This cannot be undone.`)) return;
            } else {
                if (!confirm(`Are you sure you want to delete category "${categoryNameToDelete}"? This cannot be undone.`)) return;
            }
            const backupMenu = JSON.parse(JSON.stringify(menu));
            delete menu[categoryNameToDelete];

            const success = await saveMenuToServer();
            if (success) {
                showToast(`Category "${categoryNameToDelete}" deleted successfully.`, 'success');
                if (selectedCategory === categoryNameToDelete) {
                    selectedCategory = Object.keys(menu)[0] || null;
                }
                await loadMenu();
                loadManagementData();
            } else {
                menu = backupMenu;
                showToast(`Failed to delete category "${categoryNameToDelete}" on server. Reverting.`, 'error');
                await loadMenu();
                loadManagementData();
            }
        }

        function toggleItemOptionsUIInModal() {
            const hasOptions = document.getElementById('itemHasOptionsModal').checked;
            document.getElementById('itemOptionsModalContainer').style.display = hasOptions ? 'block' : 'none';

            if(!hasOptions) {
                tempItemOptionsModal = [];
            }
            renderTemporaryOptionsListModal();
        }

        function addOptionToItemFormTempModal() {
            if (!elements.newOptionNameInputModal || !elements.newOptionPriceInputModal) return;
            const optionName = elements.newOptionNameInputModal.value.trim();
            const priceChangeText = elements.newOptionPriceInputModal.value.trim();
            const priceChange = priceChangeText === "" ? 0 : parseFloat(priceChangeText);

            if (!optionName) {
                showToast('Option name cannot be empty.', 'warning');
                return;
            }
            if (isNaN(priceChange)) {
                showToast('Price change must be a valid number or empty (for 0).', 'warning');
                return;
            }

            if (tempItemOptionsModal.find(opt => opt.name === optionName)) {
                showToast('This general option name already exists for the item.', 'warning');
                return;
            }
            
            tempItemOptionsModal.push({ name: optionName, priceChange: priceChange });
            renderTemporaryOptionsListModal();
            elements.newOptionNameInputModal.value = '';
            elements.newOptionPriceInputModal.value = '';
            elements.newOptionNameInputModal.focus();
        }

        function renderTemporaryOptionsListModal() {
            if (!elements.itemOptionsListDisplayModal) return;
            elements.itemOptionsListDisplayModal.innerHTML = '';
            if (tempItemOptionsModal.length === 0 && document.getElementById('itemHasOptionsModal').checked) {
                elements.itemOptionsListDisplayModal.innerHTML = '<p class="text-xs text-gray-500 italic w-full">No general options added yet.</p>';
                return;
            } else if (tempItemOptionsModal.length === 0 && !document.getElementById('itemHasOptionsModal').checked) {
                elements.itemOptionsListDisplayModal.innerHTML = '';
                return;
            }

            tempItemOptionsModal.forEach(opt => {
                const pillSpan = document.createElement('span');
                pillSpan.className = 'option-pill'; 
                const priceDisplay = parseFloat(opt.priceChange || 0) !== 0 ? ` (${parseFloat(opt.priceChange || 0) > 0 ? '+' : ''}€${parseFloat(opt.priceChange || 0).toFixed(2)})` : '';
                pillSpan.textContent = `${opt.name}${priceDisplay}`;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-option-btn'; 
                removeBtn.innerHTML = '&times;'; 
                removeBtn.title = `Remove option: ${opt.name}`;
                removeBtn.type = 'button'; 
                removeBtn.onclick = () => removeTemporaryOptionModal(opt.name);
                pillSpan.appendChild(removeBtn);
                elements.itemOptionsListDisplayModal.appendChild(pillSpan);
            });
        }
        function removeTemporaryOptionModal(optionNameToRemove) { 
            tempItemOptionsModal = tempItemOptionsModal.filter(opt => opt.name !== optionNameToRemove);
            renderTemporaryOptionsListModal();
        }

        let toastTimeout;
        function showToast(message, type = 'info', duration = 3000) {
            if (!elements.toast || !elements.toastMessage) return;
            clearTimeout(toastTimeout);
            elements.toastMessage.textContent = message;

            elements.toast.className = 'fixed top-5 right-5 text-white px-4 py-2 rounded-md shadow-lg text-sm z-[100] opacity-0 transition-opacity duration-300';

            switch(type) {
                case 'success': elements.toast.classList.add('bg-green-600'); break;
                case 'warning': elements.toast.classList.add('bg-yellow-500'); break;
                case 'error': elements.toast.classList.add('bg-red-600'); break;
                default: elements.toast.classList.add('bg-gray-800');
            }

            elements.toast.classList.remove('hidden');
            setTimeout(() => elements.toast.classList.remove('opacity-0'), 10);

            toastTimeout = setTimeout(() => {
                elements.toast.classList.add('opacity-0');
                setTimeout(() => elements.toast.classList.add('hidden'), 300);
            }, duration);
        }

        function prepareKitchenTicketData() {
            const ticketNumEl = document.getElementById('ticket-order-number');
            const ticketItemsEl = document.getElementById('ticket-items');
            const ticketNotesEl = document.getElementById('ticket-notes-content');
            const ticketTimeEl = document.getElementById('ticket-time');

            if(ticketNumEl) ticketNumEl.textContent = orderNumber;
            if(ticketTimeEl) ticketTimeEl.textContent = new Date().toLocaleString(navigator.language || 'en-US');

            if(ticketItemsEl) {
                ticketItemsEl.innerHTML = currentOrder.map(item => {
                    let optionStr = '';
                    if (item.generalSelectedOptions && item.generalSelectedOptions.length > 0) {
                        optionStr += ` (Opt: ${item.generalSelectedOptions.map(opt => opt.name).join(', ')})`;
                    }
                    return `<div>${item.quantity}x ${item.name}${optionStr.trim()}${item.comment ? ` <small><em>(${item.comment})</em></small>` : ''}</div>`
                }).join('');
            }
            if(ticketNotesEl) ticketNotesEl.textContent = universalOrderComment || "None";
        }

        async function loadTodaysOrdersForReprint() {
            if (!elements.todaysOrdersList) return;
            elements.todaysOrdersList.innerHTML = '<p class="text-xs text-gray-500 italic">Loading today\'s orders...</p>';
            try {
                const response = await fetch('/api/todays_orders_for_reprint');
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP ${response.status}` }));
                    throw new Error(errorData.message || `Failed to load orders: ${response.statusText}`);
                }
                const orders = await response.json();
                renderTodaysOrdersList(orders);
            } catch (error) {
                console.error("Error loading today's orders for reprint:", error);
                elements.todaysOrdersList.innerHTML = `<p class="text-xs text-red-500 italic">Error loading orders: ${error.message}. Try refreshing.</p>`;
                showToast(`Error loading orders: ${error.message}`, 'error');
            }
        }

        function renderTodaysOrdersList(orders) {
            if (!elements.todaysOrdersList) return;
            elements.todaysOrdersList.innerHTML = '';

            if (!orders || orders.length === 0) {
                elements.todaysOrdersList.innerHTML = '<p class="text-xs text-gray-500 italic">No orders found for today.</p>';
                return;
            }

            orders.forEach(order => {
                const div = document.createElement('div');
                div.className = "p-2.5 border border-gray-300 rounded-md flex justify-between items-center text-sm bg-white hover:bg-gray-50";
                
                let formattedTimestamp = order.timestamp;
                try {
                    const dateObj = new Date(order.timestamp);
                    if (!isNaN(dateObj)) {
                         formattedTimestamp = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    }
                } catch(e) { /* keep original if parsing fails */ }


                div.innerHTML = `
                    <div>
                        <span class="font-semibold text-gray-800">Order #${order.order_number}</span>
                        <span class="text-xs text-gray-600 ml-2">Table: ${order.table_number || 'N/A'}</span>
                        <span class="text-xs text-gray-500 ml-2">Time: ${formattedTimestamp}</span>
                    </div>
                    <button onclick="reprintOrder('${order.order_number}')" class="px-3 py-1.5 text-xs btn-primary text-white rounded hover:opacity-80 transition">
                        <i class="fas fa-print mr-1"></i> Reprint
                    </button>
                `;
                elements.todaysOrdersList.appendChild(div);
            });
        }

        async function reprintOrder(orderNumToReprint) {
            if (!orderNumToReprint) {
                showToast('Invalid order number for reprint.', 'error');
                return;
            }

            const reprintButton = event.target.closest('button');
            if (reprintButton) {
                reprintButton.disabled = true;
                reprintButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Reprinting...';
            }

            try {
                const response = await fetch('/api/reprint_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_number: orderNumToReprint })
                });
                const result = await response.json();

                if (response.ok) {
                    if (result.status === "success") {
                        showToast(result.message || `Order #${orderNumToReprint} REPRINTED successfully!`, 'success');
                    } else if (result.status === "warning_reprint_copy2_failed") {
                        showToast(result.message || `Order #${orderNumToReprint}: Kitchen REPRINTED. Copy 2 FAILED.`, 'warning', 7000);
                    } else { 
                        showToast(result.message || `Failed to reprint Order #${orderNumToReprint}.`, 'error', 7000);
                    }
                } else { 
                     showToast(result.message || `Server error during reprint of Order #${orderNumToReprint}: ${response.status}.`, 'error', 7000);
                }

            } catch (error) {
                console.error(`Error reprinting order ${orderNumToReprint}:`, error);
                showToast(`Network error or invalid response while reprinting Order #${orderNumToReprint}.`, 'error', 7000);
            } finally {
                 if (reprintButton) {
                    reprintButton.disabled = false;
                    reprintButton.innerHTML = '<i class="fas fa-print mr-1"></i> Reprint';
                }
            }
        }

        // --- Day Summary Modal Functions ---
        async function openDaySummaryModal() {
            if (!elements.daySummaryModal || !elements.daySummaryContent) return;
            elements.daySummaryModal.classList.remove('hidden');
            elements.daySummaryModal.classList.add('flex');
            elements.daySummaryContent.innerHTML = '<p class="text-center italic">Loading summary...</p>';

            try {
                const response = await fetch('/api/daily_summary');
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `Server error: ${response.status}`);
                }
                const summary = await response.json();
                renderDaySummary(summary);
            } catch (error) {
                elements.daySummaryContent.innerHTML = `<p class="text-center text-red-500">Error loading summary: ${error.message}</p>`;
            }
        }

        function closeDaySummaryModal() {
            if (!elements.daySummaryModal) return;
            elements.daySummaryModal.classList.add('hidden');
            elements.daySummaryModal.classList.remove('flex');
        }

        function renderDaySummary(summary) {
            if (!elements.daySummaryContent) return;
            
            if (summary.status === 'error') {
                elements.daySummaryContent.innerHTML = `<p class="text-center text-red-500">${summary.message}</p>`;
                return;
            }

            elements.daySummaryContent.innerHTML = `
                <div class="space-y-3 text-base">
                    <div class="flex justify-between items-center py-2 border-b">
                        <span class="font-medium text-gray-600">Total Orders:</span>
                        <span class="font-semibold text-gray-800">${summary.total_orders}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b">
                        <span class="font-medium text-gray-600">Total Cash Payments:</span>
                        <span class="font-semibold text-green-600">€${summary.cash_total.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b">
                        <span class="font-medium text-gray-600">Total Card Payments:</span>
                        <span class="font-semibold text-blue-600">€${summary.card_total.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center pt-3 mt-2 border-t-2 border-black">
                        <span class="text-lg font-bold text-gray-900">Grand Total:</span>
                        <span class="font-semibold text-gray-900">€${summary.grand_total.toFixed(2)}</span>
                    </div>
                </div>
            `;
        }

        // --- Analytics Functions ---

        function toggleCustomDateRangeUI(buttonEl) {
            const picker = document.getElementById('custom-date-range-picker');
            if (!picker) return;

            document.querySelectorAll('.date-range-btn').forEach(btn => btn.classList.remove('active'));
            buttonEl.classList.add('active');
            
            picker.classList.toggle('hidden');

            if (!picker.classList.contains('hidden')) {
                // Set default dates when opening
                const endDateInput = document.getElementById('endDate');
                const startDateInput = document.getElementById('startDate');
                const today = new Date().toISOString().split('T')[0];
                endDateInput.value = today;
                if (!startDateInput.value) {
                    startDateInput.value = today;
                }
            }
        }

        async function fetchAnalytics(url) {
             // Show loading state
            const analyticsContainer = document.getElementById('analyticsManagement');
            analyticsContainer.querySelectorAll('.font-bold.text-gray-900').forEach(el => el.textContent = '...');
            analyticsContainer.querySelectorAll('.max-h-48, .max-h-64, #analytics-chart-container').forEach(el => el.innerHTML = '<p class="text-xs text-gray-500 italic p-4">Loading data...</p>');

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP ${response.status}` }));
                    throw new Error(errorData.message || 'Failed to load analytics data');
                }
                const data = await response.json();
                renderAnalytics(data);
                showToast(`Analytics loaded successfully.`, "success");
            } catch (error) {
                showToast(`Error loading analytics: ${error.message}`, 'error');
                console.error("Analytics load error:", error);
            }
        }

        function loadAnalyticsData(range = 'today', buttonEl = null) {
            // Visually update the active button
            document.querySelectorAll('.date-range-btn').forEach(btn => btn.classList.remove('active'));
            if (buttonEl) buttonEl.classList.add('active');

            // Hide custom date picker if a preset is chosen
            const picker = document.getElementById('custom-date-range-picker');
            if (picker) picker.classList.add('hidden');
            
            fetchAnalytics(`/api/analytics?range=${range}`);
        }

        function fetchCustomDateRangeAnalytics() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                showToast('Please select both a start and end date.', 'warning');
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                showToast('Start date cannot be after the end date.', 'warning');
                return;
            }
            
            fetchAnalytics(`/api/analytics?range=custom&start=${startDate}&end=${endDate}`);
        }


        function renderAnalytics(data) {
            document.getElementById('kpi-gross-revenue').textContent = `€${(data.grossRevenue || 0).toFixed(2)}`;
            document.getElementById('kpi-total-orders').textContent = data.totalOrders || 0;
            document.getElementById('kpi-atv').textContent = `€${(data.atv || 0).toFixed(2)}`;
            
            document.getElementById('kpi-payment-cash').textContent = `€${(data.paymentMethods.cash || 0).toFixed(2)}`;
            document.getElementById('kpi-payment-card').textContent = `€${(data.paymentMethods.card || 0).toFixed(2)}`;

            renderList('kpi-sales-by-category', data.salesByCategory, item => `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 truncate pr-2">${item.category}</span>
                    <span class="font-medium text-gray-800 whitespace-nowrap">€${(item.total || 0).toFixed(2)}</span>
                </div>`, "No category sales yet.");
            
            renderList('kpi-top-revenue-items', data.topRevenueItems, item => `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 truncate pr-2">${item.name}</span>
                    <span class="font-medium text-gray-800 whitespace-nowrap">€${(item.revenue || 0).toFixed(2)}</span>
                </div>`, "No items sold yet.");

            renderList('kpi-best-sellers', data.bestSellers, item => `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 truncate pr-2">${item.name}</span>
                    <span class="font-medium text-gray-800 whitespace-nowrap">${item.quantity} sold</span>
                </div>`, "No items sold yet.");
            
            renderList('kpi-worst-sellers', data.worstSellers, item => `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 truncate pr-2">${item.name}</span>
                    <span class="font-medium text-gray-800 whitespace-nowrap">${item.quantity} sold</span>
                </div>`, "No underperforming items found.");

            renderSalesByHourChart(data.salesByHour);
        }

        function renderList(containerId, items, templateFn, emptyMessage) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (items && items.length > 0) {
                items.forEach(item => {
                    container.innerHTML += templateFn(item);
                });
            } else {
                container.innerHTML = `<p class="text-xs text-gray-500 italic p-2">${emptyMessage}</p>`;
            }
        }

        function renderSalesByHourChart(salesByHour) {
            const container = document.getElementById('analytics-chart-container');
            container.innerHTML = '';

            if (!salesByHour || salesByHour.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500 italic w-full text-center self-center">No sales data for this period.</p>';
                container.style.minWidth = 'auto';
                return;
            }
            
            const barWidth = 40; 
            const spaceWidth = 16; 
            container.style.minWidth = `${salesByHour.length * (barWidth + spaceWidth)}px`;

            const maxRevenue = Math.max(...salesByHour.map(h => h.total), 0);
            
            salesByHour.forEach(hourData => {
                const barHeight = maxRevenue > 0 ? (hourData.total / maxRevenue) * 100 : 0;
                const barWrapper = document.createElement('div');
                barWrapper.className = 'w-10 flex flex-col items-center justify-end h-full';
                barWrapper.innerHTML = `
                    <div class="w-full h-full flex items-end justify-center group relative">
                        <div class="bg-gray-200 hover:bg-indigo-400 w-3/4 rounded-t-sm transition-colors" style="height: ${barHeight}%"></div>
                        <div class="absolute bottom-full mb-1 w-max px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                            €${hourData.total.toFixed(2)}
                        </div>
                    </div>
                    <span class="text-xs text-gray-500 mt-1">${String(hourData.hour).padStart(2, '0')}</span>
                `;
                container.appendChild(barWrapper);
            });
        }

        // --- Shutdown Function ---
        async function shutdownApplication() {
            if (!confirm('Are you sure you want to shut down the POSPal application? This will close the server for all users.')) {
                return;
            }

            try {
                const response = await fetch('/api/shutdown', {
                    method: 'POST',
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showToast('Server is shutting down...', 'info', 5000);
                    document.body.innerHTML = `
                        <div class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center text-white p-8">
                            <h1 class="text-4xl font-bold mb-4">POSPal is Shutting Down</h1>
                            <p class="text-lg text-gray-300">You can now safely close this window.</p>
                        </div>
                    `;
                    setTimeout(() => { window.close(); }, 3000);
                } else {
                    showToast(result.message || 'Failed to initiate shutdown.', 'error');
                }
            } catch (error) {
                console.log('Shutdown command sent. The server is likely closing the connection, which is normal.');
                 showToast('Shutdown command sent. The server is closing.', 'info', 5000);
                 document.body.innerHTML = `
                    <div class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center text-white p-8">
                        <h1 class="text-4xl font-bold mb-4">POSPal is Shutting Down</h1>
                        <p class="text-lg text-gray-300">You can now safely close this window.</p>
                    </div>
                `;
                setTimeout(() => { window.close(); }, 3000);
            }
        }

        // --- NEW: Trial and License Functions ---

        async function checkAndDisplayTrialStatus() {
            try {
                const response = await fetch('/api/trial_status');
                if (!response.ok) throw new Error('Could not fetch trial status');
                const status = await response.json();

                const statusDisplay = elements.licenseStatusDisplay;
                const footerStatusDisplay = elements.footerTrialStatus;

                if (status.licensed) {
                    const licensedHTML = `<i class="fas fa-check-circle text-green-600 mr-2"></i>Fully Licensed`;
                    if(statusDisplay) statusDisplay.innerHTML = licensedHTML;
                    if(footerStatusDisplay) {
                        footerStatusDisplay.innerHTML = licensedHTML;
                        footerStatusDisplay.className = 'font-medium text-green-600';
                    }
                } else if (status.expired) {
                    const expiredHTML = `<i class="fas fa-times-circle text-red-600 mr-2"></i>Trial Expired`;
                    if(statusDisplay) statusDisplay.innerHTML = expiredHTML;
                    if(footerStatusDisplay) {
                        footerStatusDisplay.innerHTML = expiredHTML;
                        footerStatusDisplay.className = 'font-medium text-red-600';
                    }
                } else if (status.active) {
                    const days = status.days_left;
                    const dayText = days === 1 ? 'day' : 'days';
                    const trialHTML = `<i class="fas fa-info-circle text-yellow-500 mr-2"></i>Trial Version: ${days} ${dayText} remaining`;
                     if(statusDisplay) statusDisplay.innerHTML = trialHTML;
                    if(footerStatusDisplay) {
                        footerStatusDisplay.innerHTML = trialHTML;
                        footerStatusDisplay.className = 'font-medium text-yellow-500';
                    }
                }

            } catch (error) {
                console.error("Error checking trial status:", error);
                if(elements.licenseStatusDisplay) elements.licenseStatusDisplay.textContent = "Could not load status.";
                if(elements.footerTrialStatus) {
                    elements.footerTrialStatus.textContent = "Status Unknown";
                    elements.footerTrialStatus.className = 'font-medium text-gray-500';
                }
            }
        }

        async function loadHardwareId() {
            if (!elements.hardwareIdDisplay) return;
            elements.hardwareIdDisplay.textContent = "Loading...";
            try {
                const response = await fetch('/api/hardware_id');
                if (!response.ok) throw new Error('Failed to fetch Hardware ID');
                const data = await response.json();
                elements.hardwareIdDisplay.textContent = data.hardware_id || 'Not Available';
            } catch (error) {
                console.error("Error fetching hardware ID:", error);
                elements.hardwareIdDisplay.textContent = 'Error loading ID.';
            }
        }

        function copyHardwareId() {
            const hwid = elements.hardwareIdDisplay.textContent;
            if (hwid && hwid !== 'Loading...' && hwid !== 'Error loading ID.') {
                // Use the Clipboard API for modern browsers
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(hwid).then(() => {
                        showToast('Hardware ID copied to clipboard!', 'success');
                    }).catch(err => {
                        showToast('Failed to copy.', 'error');
                    });
                } else {
                    // Fallback for older/insecure contexts
                    const textArea = document.createElement("textarea");
                    textArea.value = hwid;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showToast('Hardware ID copied to clipboard!', 'success');
                    } catch (err) {
                        showToast('Failed to copy.', 'error');
                    }
                    document.body.removeChild(textArea);
                }
            } else {
                showToast('Hardware ID not available to copy.', 'warning');
            }
        }

    </script>
</body>
</html>
